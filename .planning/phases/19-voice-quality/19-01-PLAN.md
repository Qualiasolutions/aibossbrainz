---
phase: 19-voice-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(chat)/api/realtime/route.ts
  - app/(chat)/api/voice/route.ts
  - app/(chat)/api/realtime/stream/route.ts
autonomous: true

must_haves:
  truths:
    - "Realtime route uses the same TTS model and voice settings as voice-config.ts"
    - "Realtime route uses shared stripMarkdownForTTS instead of inline regex"
    - "All ElevenLabs API calls include optimize_streaming_latency parameter"
  artifacts:
    - path: "app/(chat)/api/realtime/route.ts"
      provides: "Realtime TTS with centralized config and shared markdown stripping"
      contains: "getVoiceConfig"
    - path: "app/(chat)/api/voice/route.ts"
      provides: "Main voice route with optimize_streaming_latency in JSON body"
      contains: "optimize_streaming_latency"
    - path: "app/(chat)/api/realtime/stream/route.ts"
      provides: "Realtime stream route with optimize_streaming_latency in JSON body"
      contains: "optimize_streaming_latency"
  key_links:
    - from: "app/(chat)/api/realtime/route.ts"
      to: "lib/ai/voice-config.ts"
      via: "getVoiceConfig import"
      pattern: "getVoiceConfig\\(botType\\)"
    - from: "app/(chat)/api/realtime/route.ts"
      to: "lib/voice/strip-markdown-tts.ts"
      via: "stripMarkdownForTTS import"
      pattern: "stripMarkdownForTTS\\("
    - from: "app/(chat)/api/voice/route.ts"
      to: "ElevenLabs API"
      via: "optimize_streaming_latency inside JSON.stringify body"
      pattern: "JSON\\.stringify\\([\\s\\S]*?optimize_streaming_latency"
    - from: "app/(chat)/api/realtime/stream/route.ts"
      to: "ElevenLabs API"
      via: "optimize_streaming_latency inside JSON.stringify body"
      pattern: "JSON\\.stringify\\([\\s\\S]*?optimize_streaming_latency"
    - from: "app/(chat)/api/realtime/route.ts"
      to: "ElevenLabs API"
      via: "optimize_streaming_latency inside JSON.stringify body"
      pattern: "JSON\\.stringify\\([\\s\\S]*?optimize_streaming_latency"
---

<objective>
Fix config drift, duplicate logic, and missing latency optimization across all three voice API routes.

Purpose: VOICE-04 (realtime route hardcodes wrong model/settings instead of using voice-config.ts), VOICE-06 (realtime route has inline regex instead of shared stripMarkdownForTTS), and VOICE-02 (no route sends optimize_streaming_latency to ElevenLabs). These are all straightforward import/config changes.

Output: All three voice routes use centralized config, shared text preprocessing, and optimized latency parameter.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-voice-quality/19-RESEARCH.md

@app/(chat)/api/realtime/route.ts
@app/(chat)/api/voice/route.ts
@app/(chat)/api/realtime/stream/route.ts
@lib/ai/voice-config.ts
@lib/voice/strip-markdown-tts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix realtime route config drift and markdown stripping (VOICE-04, VOICE-06)</name>
  <files>app/(chat)/api/realtime/route.ts</files>
  <action>
  Fix two issues in `app/(chat)/api/realtime/route.ts`:

  **VOICE-04 — Config drift:** Replace the hardcoded TTS config (lines ~117-137) with centralized config from voice-config.ts:
  - Import `getVoiceConfig` from `@/lib/ai/voice-config` (it already imports `getVoiceForBot` — replace that with `getVoiceConfig`)
  - Replace `const voiceId = getVoiceForBot(botType)` with `const voiceConfig = getVoiceConfig(botType)`
  - Replace `voiceId` in the fetch URL with `voiceConfig.voiceId`
  - Replace the hardcoded `model_id: "eleven_flash_v2_5"` with `voiceConfig.modelId`
  - Replace hardcoded `voice_settings: { stability: 0.5, similarity_boost: 0.75, style: 0.0, use_speaker_boost: true }` with `voice_settings: { stability: voiceConfig.settings.stability, similarity_boost: voiceConfig.settings.similarityBoost, style: voiceConfig.settings.style ?? 0, use_speaker_boost: voiceConfig.settings.useSpeakerBoost ?? true }`
  - Add `optimize_streaming_latency: 2` to the JSON.stringify body object alongside `text`, `model_id`, `voice_settings` (VOICE-02, done here since we're already modifying this route)

  **VOICE-06 — Duplicate markdown stripping:** Replace the inline regex chain (lines ~98-108) with the shared utility:
  - Import `stripMarkdownForTTS` from `@/lib/voice/strip-markdown-tts`
  - Replace the entire inline regex block (`responseText.replace(/```[\s\S]*?```/g, ...)...slice(0, 4000)`) with `const cleanText = stripMarkdownForTTS(responseText).slice(0, 4000)`
  - The shared utility handles suggestions blocks, executive markers, tables, blockquotes, horizontal rules — all of which the inline regex misses

  Also switch the fetch URL from non-streaming to streaming endpoint: change `/v1/text-to-speech/${voiceConfig.voiceId}` to `/v1/text-to-speech/${voiceConfig.voiceId}/stream` and add `Accept: 'audio/mpeg'` header if missing. This is consistent with the other routes and reduces TTFB.
  </action>
  <verify>
  Run `pnpm lint` to confirm no import/syntax errors. Grep for "eleven_flash_v2_5" in the realtime route to confirm it's gone. Grep for the inline regex patterns (`.replace(/\*\*/g, "")`) to confirm they're gone. Grep for `getVoiceConfig` and `stripMarkdownForTTS` in the route to confirm they're imported and used.
  </verify>
  <done>
  Realtime route uses `getVoiceConfig(botType)` for model and voice settings (matching voice-config.ts), uses `stripMarkdownForTTS()` for text preprocessing (matching other routes), uses streaming endpoint, and sends `optimize_streaming_latency: 2`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add optimize_streaming_latency to voice route (VOICE-02)</name>
  <files>app/(chat)/api/voice/route.ts</files>
  <action>
  Add `optimize_streaming_latency: 2` to the ElevenLabs API calls in `app/(chat)/api/voice/route.ts` (Task 1 already added it to the realtime route).

  1. In the single-voice path (the `withElevenLabsResilience` call around line 183-209): add `optimize_streaming_latency: 2` inside the `JSON.stringify({...})` body object alongside `text`, `model_id`, `voice_settings`. The parameter must be a sibling property within the JSON body, not outside it.
  2. In the `generateAudioForSegment()` function (around line 300-342): add `optimize_streaming_latency: 2` inside the `JSON.stringify({...})` body object at line ~310. Same placement — sibling of `text`, `model_id`, `voice_settings`. Note: this function currently uses the non-streaming endpoint — will be fixed in Plan 02. The parameter still works on the non-streaming endpoint per ElevenLabs docs.

  Use level 2 (not 3 or 4) to avoid text normalization issues with numbers, dates, and currency amounts per research findings.
  </action>
  <verify>
  Run `pnpm lint` to confirm no syntax errors. Grep `app/(chat)/api/voice/route.ts` for `optimize_streaming_latency` — should appear in 2 locations (single-voice path and generateAudioForSegment). Verify the value is `2` in both.
  </verify>
  <done>
  Both ElevenLabs API calls in voice/route.ts include `optimize_streaming_latency: 2` inside their JSON.stringify body objects.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add optimize_streaming_latency to realtime/stream route (VOICE-02)</name>
  <files>app/(chat)/api/realtime/stream/route.ts</files>
  <action>
  Add `optimize_streaming_latency: 2` to the ElevenLabs API call in `app/(chat)/api/realtime/stream/route.ts`.

  In the `generateAudioForSegment()` function (around line 47-97): add `optimize_streaming_latency: 2` inside the `JSON.stringify({...})` body object alongside `text`, `model_id`, `voice_settings`. The parameter must be a sibling property within the JSON body.

  Use level 2 (not 3 or 4) to avoid text normalization issues with numbers, dates, and currency amounts per research findings.
  </action>
  <verify>
  Run `pnpm lint` to confirm no syntax errors. Grep `app/(chat)/api/realtime/stream/route.ts` for `optimize_streaming_latency` — should appear at least once. Verify the value is `2`.
  </verify>
  <done>
  The ElevenLabs API call in realtime/stream/route.ts includes `optimize_streaming_latency: 2` inside its JSON.stringify body object.
  </done>
</task>

</tasks>

<verification>
1. `pnpm lint` passes with no errors
2. `grep -r "eleven_flash_v2_5" app/(chat)/api/realtime/route.ts` returns nothing (no hardcoded model)
3. `grep -r "getVoiceConfig" app/(chat)/api/realtime/route.ts` returns matches (centralized config used)
4. `grep -r "stripMarkdownForTTS" app/(chat)/api/realtime/route.ts` returns matches (shared utility used)
5. `grep -r "optimize_streaming_latency" app/(chat)/api/voice/route.ts app/(chat)/api/realtime/route.ts app/(chat)/api/realtime/stream/route.ts` returns matches in all three files
6. No inline regex for markdown stripping remains in `app/(chat)/api/realtime/route.ts`
7. In all three routes, `optimize_streaming_latency` appears within a `JSON.stringify` body block (not as a query param or standalone)
</verification>

<success_criteria>
- VOICE-02: All ElevenLabs calls include optimize_streaming_latency: 2 inside the JSON request body
- VOICE-04: Realtime route uses getVoiceConfig(botType) instead of hardcoded model/settings
- VOICE-06: Realtime route uses stripMarkdownForTTS() instead of inline regex
- All three routes pass lint
</success_criteria>

<output>
After completion, create `.planning/phases/19-voice-quality/19-01-SUMMARY.md`
</output>
