---
phase: 19-voice-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(chat)/api/realtime/route.ts
  - app/(chat)/api/voice/route.ts
  - app/(chat)/api/realtime/stream/route.ts
autonomous: true

must_haves:
  truths:
    - "Realtime route uses the same TTS model and voice settings as voice-config.ts"
    - "Realtime route uses shared stripMarkdownForTTS instead of inline regex"
    - "All ElevenLabs API calls include optimize_streaming_latency parameter"
  artifacts:
    - path: "app/(chat)/api/realtime/route.ts"
      provides: "Realtime TTS with centralized config and shared markdown stripping"
      contains: "getVoiceConfig"
    - path: "app/(chat)/api/voice/route.ts"
      provides: "Main voice route with optimize_streaming_latency"
      contains: "optimize_streaming_latency"
    - path: "app/(chat)/api/realtime/stream/route.ts"
      provides: "Realtime stream route with optimize_streaming_latency"
      contains: "optimize_streaming_latency"
  key_links:
    - from: "app/(chat)/api/realtime/route.ts"
      to: "lib/ai/voice-config.ts"
      via: "getVoiceConfig import"
      pattern: "getVoiceConfig\\(botType\\)"
    - from: "app/(chat)/api/realtime/route.ts"
      to: "lib/voice/strip-markdown-tts.ts"
      via: "stripMarkdownForTTS import"
      pattern: "stripMarkdownForTTS\\("
---

<objective>
Fix config drift, duplicate logic, and missing latency optimization across all three voice API routes.

Purpose: VOICE-04 (realtime route hardcodes wrong model/settings instead of using voice-config.ts), VOICE-06 (realtime route has inline regex instead of shared stripMarkdownForTTS), and VOICE-02 (no route sends optimize_streaming_latency to ElevenLabs). These are all straightforward import/config changes.

Output: All three voice routes use centralized config, shared text preprocessing, and optimized latency parameter.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-voice-quality/19-RESEARCH.md

@app/(chat)/api/realtime/route.ts
@app/(chat)/api/voice/route.ts
@app/(chat)/api/realtime/stream/route.ts
@lib/ai/voice-config.ts
@lib/voice/strip-markdown-tts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix realtime route config drift and markdown stripping (VOICE-04, VOICE-06)</name>
  <files>app/(chat)/api/realtime/route.ts</files>
  <action>
  Fix two issues in `app/(chat)/api/realtime/route.ts`:

  **VOICE-04 — Config drift:** Replace the hardcoded TTS config (lines ~117-137) with centralized config from voice-config.ts:
  - Import `getVoiceConfig` from `@/lib/ai/voice-config` (it already imports `getVoiceForBot` — replace that with `getVoiceConfig`)
  - Replace `const voiceId = getVoiceForBot(botType)` with `const voiceConfig = getVoiceConfig(botType)`
  - Replace `voiceId` in the fetch URL with `voiceConfig.voiceId`
  - Replace the hardcoded `model_id: "eleven_flash_v2_5"` with `voiceConfig.modelId`
  - Replace hardcoded `voice_settings: { stability: 0.5, similarity_boost: 0.75, style: 0.0, use_speaker_boost: true }` with `voice_settings: { stability: voiceConfig.settings.stability, similarity_boost: voiceConfig.settings.similarityBoost, style: voiceConfig.settings.style ?? 0, use_speaker_boost: voiceConfig.settings.useSpeakerBoost ?? true }`
  - Add `optimize_streaming_latency: 2` to the request body (VOICE-02, done here since we're already modifying)

  **VOICE-06 — Duplicate markdown stripping:** Replace the inline regex chain (lines ~98-108) with the shared utility:
  - Import `stripMarkdownForTTS` from `@/lib/voice/strip-markdown-tts`
  - Replace the entire inline regex block (`responseText.replace(/```[\s\S]*?```/g, ...)...slice(0, 4000)`) with `const cleanText = stripMarkdownForTTS(responseText).slice(0, 4000)`
  - The shared utility handles suggestions blocks, executive markers, tables, blockquotes, horizontal rules — all of which the inline regex misses

  Also switch the fetch URL from non-streaming to streaming endpoint: change `/v1/text-to-speech/${voiceConfig.voiceId}` to `/v1/text-to-speech/${voiceConfig.voiceId}/stream` and add `Accept: 'audio/mpeg'` header if missing. This is consistent with the other routes and reduces TTFB.
  </action>
  <verify>
  Run `pnpm lint` to confirm no import/syntax errors. Grep for "eleven_flash_v2_5" in the realtime route to confirm it's gone. Grep for the inline regex patterns (`.replace(/\*\*/g, "")`) to confirm they're gone. Grep for `getVoiceConfig` and `stripMarkdownForTTS` in the route to confirm they're imported and used.
  </verify>
  <done>
  Realtime route uses `getVoiceConfig(botType)` for model and voice settings (matching voice-config.ts), uses `stripMarkdownForTTS()` for text preprocessing (matching other routes), uses streaming endpoint, and sends `optimize_streaming_latency: 2`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add optimize_streaming_latency to voice and realtime/stream routes (VOICE-02)</name>
  <files>app/(chat)/api/voice/route.ts, app/(chat)/api/realtime/stream/route.ts</files>
  <action>
  Add `optimize_streaming_latency: 2` to all remaining ElevenLabs API calls that don't have it yet (Task 1 already added it to the realtime route).

  **In `app/(chat)/api/voice/route.ts`:**
  1. In the single-voice path (the `withElevenLabsResilience` call around line 183-209): add `optimize_streaming_latency: 2` to the JSON body alongside `text`, `model_id`, `voice_settings`
  2. In `generateAudioForSegment()` function (around line 300-342): add `optimize_streaming_latency: 2` to the JSON body. Note: this function currently uses the non-streaming endpoint (`/v1/text-to-speech/${voiceConfig.voiceId}` without `/stream`) — this will be fixed in Plan 02 when we rewrite collaborative generation. For now, just add the parameter to the body (it still works on the non-streaming endpoint per ElevenLabs docs).

  **In `app/(chat)/api/realtime/stream/route.ts`:**
  1. In the `generateAudioForSegment()` function (around line 47-97): add `optimize_streaming_latency: 2` to the JSON body. Same as above, currently uses non-streaming endpoint — will be fixed in Plan 02.

  Use level 2 (not 3 or 4) to avoid text normalization issues with numbers, dates, and currency amounts per research findings.
  </action>
  <verify>
  Run `pnpm lint` to confirm no syntax errors. Grep all three route files for `optimize_streaming_latency` — each should have at least one occurrence. Grep to confirm the value is `2` (not 3 or 4).
  </verify>
  <done>
  Every ElevenLabs API call across all three voice routes includes `optimize_streaming_latency: 2` in the request body.
  </done>
</task>

</tasks>

<verification>
1. `pnpm lint` passes with no errors
2. `grep -r "eleven_flash_v2_5" app/(chat)/api/realtime/route.ts` returns nothing (no hardcoded model)
3. `grep -r "getVoiceConfig" app/(chat)/api/realtime/route.ts` returns matches (centralized config used)
4. `grep -r "stripMarkdownForTTS" app/(chat)/api/realtime/route.ts` returns matches (shared utility used)
5. `grep -r "optimize_streaming_latency" app/(chat)/api/voice/route.ts app/(chat)/api/realtime/route.ts app/(chat)/api/realtime/stream/route.ts` returns matches in all three files
6. No inline regex for markdown stripping remains in `app/(chat)/api/realtime/route.ts`
</verification>

<success_criteria>
- VOICE-02: All ElevenLabs calls include optimize_streaming_latency: 2
- VOICE-04: Realtime route uses getVoiceConfig(botType) instead of hardcoded model/settings
- VOICE-06: Realtime route uses stripMarkdownForTTS() instead of inline regex
- All three routes pass lint
</success_criteria>

<output>
After completion, create `.planning/phases/19-voice-quality/19-01-SUMMARY.md`
</output>
