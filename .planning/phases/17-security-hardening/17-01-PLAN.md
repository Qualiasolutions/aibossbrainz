---
phase: 17-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/layout.tsx
  - lib/supabase/middleware.ts
autonomous: true

must_haves:
  truths:
    - "No dangerouslySetInnerHTML exists anywhere in layout files"
    - "Theme-color meta tag still initializes correctly on page load (no flash of wrong chrome color)"
    - "Unknown /api/ routes require authentication by default -- only explicitly listed routes are public"
    - "Stripe webhooks, Supabase auth callbacks, health probe, demo chat, cron jobs, and landing-page GET still work without user auth"
  artifacts:
    - path: "app/layout.tsx"
      provides: "Safe theme-color initialization via next/script"
      contains: "Script id=\"theme-color-init\" strategy=\"beforeInteractive\""
    - path: "lib/supabase/middleware.ts"
      provides: "Explicit API route allowlist"
      contains: "publicApiRoutes"
  key_links:
    - from: "app/layout.tsx"
      to: "next/script"
      via: "Script component import"
      pattern: "import Script from \"next/script\""
    - from: "lib/supabase/middleware.ts"
      to: "publicApiRoutes"
      via: "allowlist check replacing blanket /api/ bypass"
      pattern: "isPublicApiRoute"
---

<objective>
Remove the XSS vector in root layout and convert the middleware API route bypass from blanket passthrough to explicit allowlist.

Purpose: Close SEC-01 (dangerouslySetInnerHTML XSS) and SEC-02 (middleware auth bypass for all API routes) from the production audit.
Output: Two hardened files -- layout.tsx using next/script, middleware.ts with API route allowlist.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-security-hardening/17-RESEARCH.md
@app/layout.tsx
@lib/supabase/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace dangerouslySetInnerHTML with next/script (SEC-01)</name>
  <files>app/layout.tsx</files>
  <action>
  Replace the `<head>` block (lines 113-120) containing `<script dangerouslySetInnerHTML>` with a `<Script>` component using inline children syntax.

  Steps:
  1. Add `import Script from "next/script";` to imports
  2. Remove the entire `<head>...</head>` block (lines 113-120) including the biome-ignore comment
  3. Inside the `<body>` tag, before `<ThemeProvider>`, add:
     ```tsx
     <Script id="theme-color-init" strategy="beforeInteractive">
       {THEME_COLOR_SCRIPT}
     </Script>
     ```
  4. The `THEME_COLOR_SCRIPT` constant (lines 80-96) stays unchanged
  5. The biome-ignore comment is no longer needed since dangerouslySetInnerHTML is gone -- do NOT keep it

  Key constraints:
  - The `id` prop is REQUIRED for inline Script components (Next.js uses it for deduplication)
  - `strategy="beforeInteractive"` is correct because this script must run before paint to avoid theme-color flash
  - `beforeInteractive` auto-injects into `<head>` -- no manual `<head>` tag needed
  - This is the root layout (`app/layout.tsx`) which is the only place `beforeInteractive` is valid
  </action>
  <verify>
  Run: `grep -rn "dangerouslySetInnerHTML" app/layout.tsx` -- should return nothing.
  Run: `grep -n "Script.*theme-color-init" app/layout.tsx` -- should show the new Script component.
  Run: `grep -n "next/script" app/layout.tsx` -- should show the import.
  Run: `pnpm lint` -- should pass with no new warnings (the biome security lint is resolved).
  </verify>
  <done>
  Root layout uses `<Script id="theme-color-init" strategy="beforeInteractive">` with inline children. No `dangerouslySetInnerHTML` exists in any layout file. The biome-ignore comment is removed. Lint passes clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert middleware to API route allowlist (SEC-02)</name>
  <files>lib/supabase/middleware.ts</files>
  <action>
  Replace the blanket `/api/` bypass at line 128 with an explicit allowlist of public API routes.

  Steps:
  1. Before the `// Allow public routes and API routes` comment (line 127), add the public API routes array:
     ```typescript
     // API routes accessible without user authentication.
     // All other /api/ routes require an authenticated session (defense-in-depth).
     // NOTE: Some listed routes have their own auth (CRON_SECRET, Stripe signatures).
     const publicApiRoutes = [
       "/api/auth",              // Supabase auth callbacks
       "/api/stripe/webhook",    // Stripe webhook (has signature verification)
       "/api/health",            // Monitoring probes (returns minimal info after SEC-04)
       "/api/demo/chat",         // Demo chat for unauthenticated visitors
       "/api/admin/landing-page",// Landing page content (GET is public, POST has isUserAdmin check)
       "/api/cron/",             // Vercel cron jobs (have CRON_SECRET auth)
     ];

     const isPublicApiRoute = request.nextUrl.pathname.startsWith("/api/") &&
       publicApiRoutes.some(
         (route) =>
           request.nextUrl.pathname === route ||
           request.nextUrl.pathname.startsWith(`${route}/`)
       );
     ```
  2. Replace line 128:
     FROM: `if (isPublicRoute || request.nextUrl.pathname.startsWith("/api/")) {`
     TO:   `if (isPublicRoute || isPublicApiRoute) {`
  3. Update the comment on that line from "Allow public routes and API routes" to "Allow public page routes and explicitly listed public API routes"

  Critical: The `(chat)` route group is invisible in URLs. `app/(chat)/api/chat/route.ts` maps to `/api/chat`. These routes are NOT in the allowlist, so unauthenticated requests to `/api/chat`, `/api/realtime`, `/api/voice`, `/api/subscription`, etc. will now be redirected to login by middleware. This is correct -- they all have internal auth checks too, but middleware is the first gate (defense-in-depth).

  Do NOT add `/api/stripe/checkout` or `/api/stripe/portal` to the allowlist -- they require auth (they use withCsrf + createClient internally).
  </action>
  <verify>
  Run: `grep -n "startsWith.*\"/api/\"" lib/supabase/middleware.ts` -- should only appear inside the isPublicApiRoute logic, NOT as a standalone bypass.
  Run: `grep -n "publicApiRoutes" lib/supabase/middleware.ts` -- should show the array and the check.
  Run: `grep -n "isPublicApiRoute" lib/supabase/middleware.ts` -- should show declaration and usage.
  Run: `pnpm lint` -- should pass.
  </verify>
  <done>
  Middleware uses an explicit allowlist (`publicApiRoutes`) for unauthenticated API access. The blanket `/api/` bypass is removed. Only `/api/auth`, `/api/stripe/webhook`, `/api/health`, `/api/demo/chat`, `/api/admin/landing-page`, and `/api/cron/` are publicly accessible. All other API routes require authentication at the middleware level.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "dangerouslySetInnerHTML" app/` -- no results in any layout file
2. `grep -c "publicApiRoutes" lib/supabase/middleware.ts` -- at least 2 occurrences (declaration + usage)
3. `pnpm lint` passes with no new errors
</verification>

<success_criteria>
- Zero instances of `dangerouslySetInnerHTML` in layout files
- Theme-color script uses `next/script` with `beforeInteractive` strategy
- Middleware has explicit `publicApiRoutes` array -- new API routes default to requiring auth
- Known public API routes (auth, webhook, health, demo, landing-page, cron) remain accessible
- Lint passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/17-security-hardening/17-01-SUMMARY.md`
</output>
