---
phase: 06-bug-fixes-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(admin)/admin/users/[id]/page.tsx
  - components/sidebar-history-item.tsx
  - components/sidebar-history.tsx
  - app/auth/callback/route.ts
autonomous: true

must_haves:
  truths:
    - "Clicking user row in admin panel opens user details page"
    - "Pinned conversation can be unpinned and returns to regular list"
    - "Email confirmation redirects to appropriate page based on user state"
  artifacts:
    - path: "app/(admin)/admin/users/[id]/page.tsx"
      provides: "User details page for admin panel"
      min_lines: 80
  key_links:
    - from: "components/admin/users-table.tsx"
      to: "/admin/users/[id]"
      via: "window.open navigation"
      pattern: "/admin/users/"
    - from: "components/sidebar-history-item.tsx"
      to: "/api/chat PATCH"
      via: "fetch with isPinned"
      pattern: "isPinned.*newPinState"
---

<objective>
Fix three bugs in Phase 6: admin panel user details 404, unpin functionality, and email confirmation redirect.

Purpose: Resolve critical UX issues affecting admin users and regular users.
Output: Working user details page, correct unpin behavior, proper email redirect flow.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@CLAUDE.md
@app/(admin)/admin/users/page.tsx
@components/admin/users-table.tsx
@lib/admin/queries.ts
@components/sidebar-history-item.tsx
@components/sidebar-history.tsx
@app/auth/callback/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Admin User Details Page</name>
  <files>app/(admin)/admin/users/[id]/page.tsx</files>
  <action>
Create dynamic route page for user details at `app/(admin)/admin/users/[id]/page.tsx`.

The page should:
1. Use existing `getUserById` from `lib/admin/queries.ts` (already exists and returns AdminUser with stats)
2. Display user profile info: displayName, email, companyName, industry, businessGoals
3. Display subscription info: type, status, start/end dates, daysRemaining calculation
4. Display activity stats: chatCount, messageCount, lastActiveAt
5. Display admin status badge if user.isAdmin
6. Include "Back to Users" link to /admin/users
7. Use similar styling to the conversation detail page at `app/(admin)/admin/conversations/[id]/page.tsx`
8. Call notFound() if user not found
9. Set `export const dynamic = "force-dynamic"`

Pattern to follow from conversations/[id]/page.tsx:
- params is a Promise, await it to get the id
- Use formatDistanceToNow for dates
- Use similar card layout with rounded-xl border border-neutral-200 bg-white shadow-sm
  </action>
  <verify>
1. Navigate to /admin/users in browser
2. Click "View Details" in dropdown menu for any user
3. Verify page loads at /admin/users/{userId} without 404
4. Verify user info displays correctly
  </verify>
  <done>User details page renders user profile, subscription info, and activity stats without 404 error</done>
</task>

<task type="auto">
  <name>Task 2: Fix Unpin Functionality - Force SWR Revalidation</name>
  <files>components/sidebar-history-item.tsx, components/sidebar-history.tsx</files>
  <action>
The unpin bug occurs because the optimistic update changes `isPinned` to false, but the `groupChatsByDate` function in sidebar-history.tsx still shows the item in pinned section until page refresh.

Root cause: The local `isPinned` state in sidebar-history-item.tsx gets out of sync with the parent's SWR cache.

Fix approach:
1. In sidebar-history-item.tsx, remove local `isPinned` state - use `chat.isPinned` directly from props
2. The `handlePinToggle` callback already updates SWR cache correctly
3. After successful PATCH, call onPinToggle callback which updates SWR cache
4. The memo comparison already handles `chat.isPinned` changes

Changes to sidebar-history-item.tsx:
- Remove: `const [isPinned, setIsPinned] = useState(chat.isPinned ?? false);`
- Use `chat.isPinned` directly instead of local state
- In handlePinToggle: calculate newPinState as `!chat.isPinned`
- Remove `setIsPinned(newPinState)` after successful response (parent updates via onPinToggle)
- Keep isPinLoading state for loading indicator
  </action>
  <verify>
1. Open chat sidebar
2. Pin a conversation (star icon appears, moves to "Pinned" section)
3. Click "Unpin" on the pinned conversation
4. Verify conversation immediately moves back to its date-based section (Today, Yesterday, etc.)
5. No page refresh required
  </verify>
  <done>Unpinning a conversation immediately moves it from Pinned section to correct date section without page refresh</done>
</task>

<task type="auto">
  <name>Task 3: Improve Email Confirmation Redirect Logic</name>
  <files>app/auth/callback/route.ts</files>
  <action>
Current flow redirects new users (without onboardedAt) to /subscribe if no active subscription.
This is correct behavior, but the UX feedback suggests users expect to land on an onboarding page.

Review the current logic:
1. If `plan` query param exists -> /subscribe?plan={plan} (correct)
2. If no active subscription -> /subscribe (correct - user needs to pay first)
3. If active subscription -> redirect to `next` param or /new (correct)

The issue may be that after email confirmation, users with pending subscriptions need clearer flow.

Improvements:
1. Add a `type` query param check: if `type=signup` or `type=recovery`, handle differently
2. For new signups without subscription: redirect to /subscribe with a welcome message param
3. After successful subscription (handled by Stripe webhook), user should land on onboarding

Update redirect logic:
- If isNewUser (no onboardedAt) AND no active subscription:
  - Redirect to `/subscribe?welcome=true` (landing page can show welcome message)
- If isNewUser AND has active subscription:
  - Redirect to `/new?onboard=true` (can trigger welcome modal)
- If returning user with active subscription:
  - Redirect to `next` param or `/new`

Note: Keep existing behavior for `plan` param (takes priority).
  </action>
  <verify>
1. Create test user via admin panel (sends invite email)
2. Click email confirmation link
3. Verify redirect goes to /subscribe?welcome=true for new users
4. After completing subscription, verify redirect to /new with welcome experience
  </verify>
  <done>Email confirmation redirects new users to subscribe page with welcome context, returning users to app</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Admin panel: /admin/users -> click any user -> details page loads
2. Sidebar: Pin chat -> Unpin chat -> chat moves to correct section immediately
3. Auth flow: Email confirm -> appropriate redirect based on user state
4. Run `pnpm lint` - no errors
5. Run `npx tsc --noEmit` - no type errors
</verification>

<success_criteria>
1. GET /admin/users/{id} returns 200 with user details (not 404)
2. Unpin action immediately updates sidebar grouping without refresh
3. Email callback redirects appropriately based on subscription and onboarding state
4. All existing functionality preserved (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/06-bug-fixes-ux/06-01-SUMMARY.md`
</output>
