---
phase: 13-ai-content-voice
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/bot-personalities.ts
  - lib/voice/strip-markdown-tts.ts
  - app/(chat)/api/voice/route.ts
  - app/(chat)/api/realtime/stream/route.ts
  - hooks/use-auto-speak.ts
autonomous: true

must_haves:
  truths:
    - "AI produces actual email drafts, social posts, and ad copy when asked, not just advice about how to write them"
    - "Voice playback does not read table rows, suggestions JSON, or code blocks aloud"
    - "All three voice paths (manual play, auto-speak, realtime) use the same text preprocessing"
  artifacts:
    - path: "lib/bot-personalities.ts"
      provides: "Content generation instructions in executive system prompts"
      contains: "CONTENT GENERATION"
    - path: "lib/voice/strip-markdown-tts.ts"
      provides: "Shared TTS text preprocessing utility"
      exports: ["stripMarkdownForTTS"]
    - path: "app/(chat)/api/voice/route.ts"
      provides: "Voice route using shared stripMarkdownForTTS"
      contains: "stripMarkdownForTTS"
    - path: "app/(chat)/api/realtime/stream/route.ts"
      provides: "Realtime route using shared stripMarkdownForTTS"
      contains: "stripMarkdownForTTS"
    - path: "hooks/use-auto-speak.ts"
      provides: "Auto-speak hook with no duplicated text cleaning"
  key_links:
    - from: "lib/bot-personalities.ts"
      to: "lib/ai/prompts.ts"
      via: "getSystemPrompt() called in systemPrompt builder"
      pattern: "getSystemPrompt"
    - from: "lib/voice/strip-markdown-tts.ts"
      to: "app/(chat)/api/voice/route.ts"
      via: "import stripMarkdownForTTS"
      pattern: "from.*strip-markdown-tts"
    - from: "lib/voice/strip-markdown-tts.ts"
      to: "app/(chat)/api/realtime/stream/route.ts"
      via: "import stripMarkdownForTTS"
      pattern: "from.*strip-markdown-tts"
---

<objective>
Enhance AI executives to produce ready-to-use business content (email drafts, social posts, ad copy) and consolidate voice text preprocessing into a single shared utility that strips tables, suggestions JSON, and code blocks before TTS.

Purpose: AI-01 requires executives to generate actual deliverables, not just advice. AI-02 requires clean voice playback. The current codebase has stripMarkdown duplicated in 3 places with inconsistent handling (voice route missing suggestions stripping, auto-speak doing its own partial cleanup).
Output: Enhanced system prompts + one shared `stripMarkdownForTTS` utility used by all voice paths.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-ai-content-voice/13-RESEARCH.md
@lib/bot-personalities.ts
@lib/ai/prompts.ts
@lib/ai/parse-suggestions.ts
@app/(chat)/api/voice/route.ts
@app/(chat)/api/realtime/stream/route.ts
@hooks/use-auto-speak.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add content generation instructions to executive system prompts</name>
  <files>lib/bot-personalities.ts</files>
  <action>
Add a new `CONTENT_GENERATION_INSTRUCTIONS` constant (similar to the existing `FORMATTING_INSTRUCTIONS` and `IDENTITY_RULES` constants) and inject it into each executive's `SYSTEM_PROMPTS` entry.

The instructions should tell the AI:
1. When asked to "create", "write", "draft", or "produce" business content, DO NOT give advice about how to write it. PRODUCE the actual content directly.
2. Content types to produce when asked: email drafts (with Subject, Greeting, Body, CTA, Signature), social media posts (platform-specific with Hook, Body, Hashtags), ad copy (Headlines, Descriptions, CTAs), sales scripts, press releases, blog post outlines, presentation talking points.
3. Format rules: Present deliverables using horizontal rules (---) to separate sections. Use **bold labels** for structure (Subject:, Hook:, Body:, CTA:). Do NOT wrap content in code blocks (already covered by FORMATTING_INSTRUCTIONS but reinforce). Tailor to the user's specific business context from the conversation.
4. Persona voice in content: Alexandria writes creative, brand-forward, emotionally resonant copy. Kim writes direct, results-oriented, urgency-driven copy. In collaborative mode, note which executive authored each piece.

Keep it concise (avoid prompt bloat per pitfall #1 from research). Append `${CONTENT_GENERATION_INSTRUCTIONS}` after `${FORMATTING_INSTRUCTIONS}` in each of the three SYSTEM_PROMPTS entries (alexandria, kim, collaborative).

Do NOT modify IDENTITY_RULES, FORMATTING_INSTRUCTIONS, FOCUS_MODES, or any other existing content. Only ADD the new constant and its injection points.
  </action>
  <verify>
Run `pnpm lint` to confirm no syntax errors. Grep `lib/bot-personalities.ts` for "CONTENT_GENERATION" to confirm the constant exists and is referenced in all three prompts.
  </verify>
  <done>
All three executive system prompts (alexandria, kim, collaborative) include content generation instructions. The instructions tell the AI to produce actual deliverables when asked, with format guidance and persona-specific voice notes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Consolidate voice text preprocessing into shared utility</name>
  <files>
    lib/voice/strip-markdown-tts.ts
    app/(chat)/api/voice/route.ts
    app/(chat)/api/realtime/stream/route.ts
    hooks/use-auto-speak.ts
  </files>
  <action>
**Create `lib/voice/strip-markdown-tts.ts`:**

Export a `stripMarkdownForTTS(text: string): string` function that consolidates ALL text preprocessing for TTS into one place. It must handle (in order):

1. Suggestions blocks: Strip ```suggestions...``` code blocks AND raw JSON suggestion arrays at end of text. Use the patterns from `lib/ai/parse-suggestions.ts`: `/```suggestions\s*[\s\S]*?```/g` for code block format AND `/\n*\[\s*\{[\s\S]*?"category"[\s\S]*?"text"[\s\S]*?\}\s*\]\s*$/` for raw JSON format.
2. Executive name prefixes (collaborative mode markers): Same patterns as current `MARKDOWN_PATTERNS` in voice route.
3. Headers: `#{1,6}\s+`
4. Bold/italic: `**text**` -> `text`, `*text*` -> `text`, `__text__` -> `text`, `_text_` -> `text`
5. Links: `[text](url)` -> `text`
6. Images: `![alt](url)` -> remove entirely
7. Code blocks: ``` ... ``` -> remove entirely (don't read code aloud)
8. Inline code: `` `text` `` -> `text`
9. Blockquotes: `> ` prefix removal
10. Horizontal rules: `---` lines -> remove
11. Table rows: Lines matching `|...|` -> replace the entire table block with `"I've included a table in the text version."` (ONE verbal cue per table, not per row). To detect table boundaries: find consecutive lines matching `^\|` and replace each contiguous block with the verbal cue.
12. Multiple newlines: 3+ newlines -> 2 newlines
13. Trim whitespace

Also export `parseCollaborativeSegments(text: string): SpeakerSegment[]` and the `SpeakerSegment` type from this file (move from voice route). This avoids the duplication between voice route and realtime route.

**Update `app/(chat)/api/voice/route.ts`:**
- Remove the local `MARKDOWN_PATTERNS`, `stripMarkdown`, `parseCollaborativeSegments`, and `SpeakerSegment` definitions.
- Import `{ stripMarkdownForTTS, parseCollaborativeSegments }` from `@/lib/voice/strip-markdown-tts`.
- Replace all calls to `stripMarkdown(...)` with `stripMarkdownForTTS(...)`.

**Update `app/(chat)/api/realtime/stream/route.ts`:**
- Remove the local `MARKDOWN_PATTERNS`, `stripMarkdown`, `parseCollaborativeSegments`, and `SpeakerSegment` definitions.
- Import `{ stripMarkdownForTTS, parseCollaborativeSegments }` from `@/lib/voice/strip-markdown-tts`.
- Replace all calls to `stripMarkdown(...)` with `stripMarkdownForTTS(...)`.

**Update `hooks/use-auto-speak.ts`:**
- Remove the inline text cleaning block (lines 255-274 that manually strip code blocks, inline code, and code-referencing phrases).
- Instead, after extracting `textContent` from message parts, call: `const { stripMarkdownForTTS } = await import("@/lib/voice/strip-markdown-tts")` (dynamic import since this is a client component, OR import statically at top if the utility has no server-only deps -- it's pure regex, so static import is fine).
- Import `stripMarkdownForTTS` at the top of the file and apply it: `textContent = stripMarkdownForTTS(textContent)`.

**Important:** The voice route's `parseCollaborativeSegments` and the realtime route's `parseCollaborativeSegments` are nearly identical. Use the voice route version (it has the more robust AbortController-based `generateAudioForSegment`). The `generateAudioForSegment` functions stay in their respective route files since they have different signatures (voice route takes `externalSignal`, realtime route doesn't).
  </action>
  <verify>
1. Run `pnpm lint` -- no errors.
2. Grep for `stripMarkdown` in the codebase (excluding .planning/) -- should only appear in `lib/voice/strip-markdown-tts.ts` (definition), `lib/clipboard-utils.ts` (different function: `stripMarkdownForClipboard`), and the component files that reference clipboard utils. Should NOT appear in voice route, realtime route, or auto-speak hook anymore.
3. Grep for `suggestions` in `lib/voice/strip-markdown-tts.ts` -- confirms suggestions stripping is included.
  </verify>
  <done>
One shared `stripMarkdownForTTS` utility exists at `lib/voice/strip-markdown-tts.ts`. All three voice paths (manual play via /api/voice, auto-speak hook, realtime stream) import and use it. Suggestions JSON blocks are stripped. Tables are replaced with a brief verbal cue. No duplicated text cleaning logic remains.
  </done>
</task>

</tasks>

<verification>
1. `pnpm lint` passes with no errors
2. `lib/bot-personalities.ts` contains `CONTENT_GENERATION_INSTRUCTIONS` referenced in all 3 executive prompts
3. `lib/voice/strip-markdown-tts.ts` exists and exports `stripMarkdownForTTS` and `parseCollaborativeSegments`
4. No local `stripMarkdown` function remains in `app/(chat)/api/voice/route.ts` or `app/(chat)/api/realtime/stream/route.ts`
5. `hooks/use-auto-speak.ts` has no inline code-block stripping regex (old lines 255-274 removed)
6. Suggestions regex pattern exists in the shared utility
</verification>

<success_criteria>
- AI system prompts instruct executives to produce actual deliverables when asked (email drafts, social posts, ad copy)
- Voice text preprocessing is consolidated into one shared utility used by all 3 voice paths
- Suggestions JSON blocks are stripped before TTS (fixing the bug where /api/voice didn't strip them)
- Tables produce a single verbal cue ("I've included a table in the text version") instead of being silently removed
- pnpm lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/13-ai-content-voice/13-01-SUMMARY.md`
</output>
