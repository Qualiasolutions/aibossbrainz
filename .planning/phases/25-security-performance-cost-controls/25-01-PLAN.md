---
phase: 25-security-performance-cost-controls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/demo/chat/route.ts
  - app/(chat)/api/document/route.ts
  - app/(chat)/api/vote/route.ts
  - app/(chat)/api/subscription/route.ts
  - app/(chat)/api/support/route.ts
  - app/(chat)/api/support/[ticketId]/messages/route.ts
  - app/(chat)/api/profile/route.ts
  - app/(chat)/api/canvas/route.ts
  - vercel.json
  - package.json
autonomous: true

must_haves:
  truths:
    - "API validation errors return generic 'bad request' messages, not Zod schema details"
    - "CSP header includes upgrade-insecure-requests directive"
    - "ajv vulnerability is resolved via pnpm override (>=8.18.0)"
  artifacts:
    - path: "app/api/demo/chat/route.ts"
      provides: "Sanitized ZodError handler"
      contains: "ChatSDKError"
    - path: "app/(chat)/api/document/route.ts"
      provides: "Sanitized validation error response"
      contains: "ChatSDKError"
    - path: "app/(chat)/api/vote/route.ts"
      provides: "Sanitized validation error response"
      contains: "ChatSDKError"
    - path: "app/(chat)/api/subscription/route.ts"
      provides: "Sanitized validation error response"
      contains: "ChatSDKError"
    - path: "app/(chat)/api/support/route.ts"
      provides: "Sanitized validation error response"
      contains: "ChatSDKError"
    - path: "app/(chat)/api/support/[ticketId]/messages/route.ts"
      provides: "Sanitized validation error response"
      contains: "ChatSDKError"
    - path: "app/(chat)/api/profile/route.ts"
      provides: "Sanitized validation error response"
      contains: "ChatSDKError"
    - path: "app/(chat)/api/canvas/route.ts"
      provides: "Sanitized validation error response"
      contains: "ChatSDKError"
    - path: "vercel.json"
      provides: "Tightened CSP with upgrade-insecure-requests"
      contains: "upgrade-insecure-requests"
    - path: "package.json"
      provides: "ajv override >=8.18.0"
      contains: "ajv"
  key_links:
    - from: "all 8 API routes"
      to: "lib/errors.ts ChatSDKError"
      via: "import and use for validation failures"
      pattern: "ChatSDKError.*bad_request"
---

<objective>
Fix Zod validation error detail leaks in 8 API routes, tighten CSP policy, and resolve ajv dependency vulnerability.

Purpose: Close security gaps where validation error responses leak internal schema details (field names, types, constraints) to clients, and harden the Content-Security-Policy.
Output: All API validation errors return generic messages; CSP is tightened; ajv vulnerability patched.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-security-performance-cost-controls/25-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sanitize Zod error responses in all 8 leaking API routes (SEC-01)</name>
  <files>
    app/api/demo/chat/route.ts
    app/(chat)/api/document/route.ts
    app/(chat)/api/vote/route.ts
    app/(chat)/api/subscription/route.ts
    app/(chat)/api/support/route.ts
    app/(chat)/api/support/[ticketId]/messages/route.ts
    app/(chat)/api/profile/route.ts
    app/(chat)/api/canvas/route.ts
  </files>
  <action>
    For each of the 8 routes, replace the Zod error detail leak with the established pattern:

    1. **app/api/demo/chat/route.ts** (lines 199-203): The `catch (error)` block at the bottom checks `error instanceof z.ZodError` and returns `{ error: "Invalid request", details: error.errors }`. Replace with: log the error server-side via `logger.warn({ errors: error.flatten() }, "Demo chat validation failed")`, then return `Response.json({ error: "Invalid request" }, { status: 400 })`. Remove `details` field entirely. Import `ChatSDKError` from `@/lib/errors` and use `new ChatSDKError("bad_request:api").toResponse()` instead of manual Response.json if ChatSDKError is already imported (it is not in this route -- use manual Response.json with just `{ error: "Invalid request" }` to avoid adding unnecessary imports to the demo route, OR import ChatSDKError for consistency).

    2. **app/(chat)/api/document/route.ts** (line 90): In POST handler, `return Response.json({ error: parsed.error.flatten() }, { status: 400 })`. Replace with: `logger.warn({ errors: parsed.error.flatten() }, "Document validation failed"); return new ChatSDKError("bad_request:api").toResponse();`. ChatSDKError is already imported.

    3. **app/(chat)/api/vote/route.ts** (line 67): In PATCH handler, `return Response.json({ error: parsed.error.flatten() }, { status: 400 })`. Replace with: `logger.warn({ errors: parsed.error.flatten() }, "Vote validation failed"); return new ChatSDKError("bad_request:api").toResponse();`. ChatSDKError is already imported.

    4. **app/(chat)/api/subscription/route.ts** (line 196): In POST handler, `return Response.json({ error: parsed.error.flatten() }, { status: 400 })`. Replace with: `logger.warn({ errors: parsed.error.flatten() }, "Subscription action validation failed"); return new ChatSDKError("bad_request:api").toResponse();`. ChatSDKError is already imported.

    5. **app/(chat)/api/support/route.ts** (line 55): In POST handler, `return Response.json({ error: parsed.error.flatten() }, { status: 400 })`. Replace with: `logger.warn({ errors: parsed.error.flatten() }, "Support ticket validation failed"); return new ChatSDKError("bad_request:api").toResponse();`. ChatSDKError is already imported.

    6. **app/(chat)/api/support/[ticketId]/messages/route.ts** (lines 32-35): In POST handler, `return Response.json({ error: parsed.error.flatten() }, { status: 400 })`. Replace with: `logger.warn({ errors: parsed.error.flatten() }, "Support message validation failed"); return new ChatSDKError("bad_request:api").toResponse();`. ChatSDKError is already imported.

    7. **app/(chat)/api/profile/route.ts** (lines 148-152): In POST handler, the block returns `{ error: "Invalid input", details: parseResult.error.flatten() }`. Replace with: the `apiLog.warn` line is already there (good), just change the return to `return new ChatSDKError("bad_request:api").toResponse();`. Remove the `details` field. ChatSDKError is already imported.

    8. **app/(chat)/api/canvas/route.ts** (lines 88-93): In POST handler, `return Response.json({ error: parseResult.error.flatten() }, { status: 400 })`. Replace with: `logger.warn({ errors: parseResult.error.flatten() }, "Canvas validation failed"); return new ChatSDKError("bad_request:api").toResponse();`. ChatSDKError is already imported.

    For the demo route specifically: since it already has `import { logger }` and we want consistency, import ChatSDKError: `import { ChatSDKError } from "@/lib/errors";` and replace the ZodError catch block with `logger.warn({ errors: error.flatten() }, "Demo chat validation failed"); return new ChatSDKError("bad_request:api").toResponse();`. Remove the entire `if (error instanceof z.ZodError)` branch and use a general pattern -- but keep the `z.ZodError` check for the server-side log. Actually, the simplest approach: change lines 199-203 to:
    ```
    if (error instanceof z.ZodError) {
      logger.warn({ errors: error.flatten() }, "Demo chat validation failed");
      return Response.json({ error: "Invalid request" }, { status: 400 });
    }
    ```
    This removes `details: error.errors` while keeping the error check structure.
  </action>
  <verify>
    Run `pnpm build` to confirm no import/type errors.
    Run `grep -r "error\.flatten()" --include="*.ts" app/ | grep -v "logger\|apiLog\|warn\|error("` to confirm no remaining Zod detail leaks in response payloads (should return zero lines where flatten appears in Response.json calls).
  </verify>
  <done>All 8 routes log Zod details server-side and return generic error messages to clients. No route returns `error.flatten()`, `error.errors`, or `details: parseResult.error.flatten()` in HTTP response bodies.</done>
</task>

<task type="auto">
  <name>Task 2: Tighten CSP and fix ajv vulnerability (SEC-02, SEC-03)</name>
  <files>
    vercel.json
    package.json
  </files>
  <action>
    **SEC-02: CSP tightening in vercel.json:**
    In the main CSP header value (line 27), make these changes:
    1. Add `upgrade-insecure-requests;` at the END of the CSP value string (before the closing quote). This ensures all HTTP requests are upgraded to HTTPS.
    2. Keep `'unsafe-inline'` for now (research confirms nonce migration is deferred). Add a code comment above the headers array explaining: CSP uses unsafe-inline because nonce-based CSP requires middleware-based dynamic headers and forces all pages to dynamic rendering. Defer to dedicated security phase. Note: vercel.json does not support comments, so skip this -- instead document in CLAUDE.md later (Phase 26 scope).

    The final CSP `script-src` stays as `'self' 'unsafe-inline' https://vercel.live https://*.vercel-scripts.com https://cdn.jsdelivr.net` (no change to script-src).

    Just append `upgrade-insecure-requests` as a new directive at the end of the CSP value.

    **SEC-03: ajv override in package.json:**
    In the `pnpm.overrides` section (lines 119-126), add `"ajv": ">=8.18.0"` after the existing `"qs"` entry. This fixes the ReDoS vulnerability (GHSA-2g4f-4pwh-qvx6) in ajv@8.17.1 which comes through `@sentry/nextjs > @sentry/webpack-plugin > webpack > schema-utils > ajv`.

    After editing package.json, run `pnpm install` to apply the override, then `pnpm build` to verify Sentry source maps and webpack still work correctly.
  </action>
  <verify>
    1. `grep "upgrade-insecure-requests" vercel.json` returns a match.
    2. `grep '"ajv"' package.json` returns the override line.
    3. `pnpm build` succeeds without errors (Sentry source maps upload, webpack schema validation works).
    4. `pnpm audit` no longer reports the ajv ReDoS vulnerability.
  </verify>
  <done>CSP includes upgrade-insecure-requests directive. ajv override resolves the ReDoS vulnerability. Build succeeds with all changes.</done>
</task>

</tasks>

<verification>
1. `grep -rn "error\.flatten\(\)\|error\.errors" --include="*.ts" app/ | grep -v "logger\|apiLog\|warn\|\.error(" | grep "Response\|json\|details"` returns no matches (no Zod details in responses)
2. CSP in vercel.json contains `upgrade-insecure-requests`
3. `pnpm build` passes
4. `pnpm audit` shows no ajv vulnerability
</verification>

<success_criteria>
- Zero API routes leak Zod validation details in HTTP responses
- CSP header is tightened with upgrade-insecure-requests
- ajv ReDoS vulnerability is patched via pnpm override
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/25-security-performance-cost-controls/25-01-SUMMARY.md`
</output>
