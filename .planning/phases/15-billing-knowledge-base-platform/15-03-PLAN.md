---
phase: 15-billing-knowledge-base-platform
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(admin)/admin/users/[id]/page.tsx
  - lib/admin/queries.ts
  - app/(admin)/admin/analytics/page.tsx
  - app/(chat)/api/reactions/route.ts
  - lib/db/queries/message.ts
  - components/message-reactions.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can set a user's type to 'team' or 'client' from the user detail page"
    - "Analytics revenue metrics exclude team users, showing only client-based revenue"
    - "User can apply multiple reaction types to the same message simultaneously"
    - "Clicking an already-active reaction toggles it off without affecting other active reactions"
  artifacts:
    - path: "app/(admin)/admin/users/[id]/page.tsx"
      provides: "userType dropdown in admin user edit form"
      contains: "userType"
    - path: "app/(admin)/admin/analytics/page.tsx"
      provides: "Revenue filtering by user category"
      contains: "client"
    - path: "app/(chat)/api/reactions/route.ts"
      provides: "Toggle-based reaction API (add/remove specific type, not replace-all)"
      contains: "toggle"
    - path: "lib/db/queries/message.ts"
      provides: "Updated reaction queries supporting multi-select"
      contains: "reactionType"
    - path: "components/message-reactions.tsx"
      provides: "Multi-select reaction UI with array state"
      contains: "ReactionType[]"
  key_links:
    - from: "app/(chat)/api/reactions/route.ts"
      to: "lib/db/queries/message.ts"
      via: "addMessageReaction/removeMessageReaction with reactionType param"
      pattern: "removeMessageReaction.*reactionType"
    - from: "components/message-reactions.tsx"
      to: "app/(chat)/api/reactions/route.ts"
      via: "POST/DELETE with specific reactionType in body"
      pattern: "csrfFetch.*reactions"
    - from: "app/(admin)/admin/analytics/page.tsx"
      to: "lib/admin/queries.ts"
      via: "filtered analytics queries excluding team users"
      pattern: "userType.*client"
---

<objective>
Add user category management for analytics revenue filtering and refactor the reaction system from single-select to multi-select.

Purpose: Analytics currently counts all users' subscriptions as revenue, but team (internal) users inflate the numbers. Admin needs to categorize users and see client-only revenue. The reaction system should allow users to mark a message with multiple reactions simultaneously (e.g., both "Actionable" and "Save for Later").
Output: Admin user type dropdown, filtered analytics, multi-select reaction system.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-billing-knowledge-base-platform/15-RESEARCH.md
@app/(admin)/admin/users/[id]/page.tsx
@lib/admin/queries.ts
@app/(admin)/admin/analytics/page.tsx
@app/(chat)/api/reactions/route.ts
@lib/db/queries/message.ts
@components/message-reactions.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: User category management and analytics filtering</name>
  <files>app/(admin)/admin/users/[id]/page.tsx, lib/admin/queries.ts, app/(admin)/admin/analytics/page.tsx</files>
  <action>
  1. **Apply Supabase migration** (project ID: `esymbjpzjjkffpfqukxw`):
     - Set default value for `userType` column: `ALTER TABLE "User" ALTER COLUMN "userType" SET DEFAULT 'client';`
     - Update existing NULL userType values: `UPDATE "User" SET "userType" = 'client' WHERE "userType" IS NULL;`

  2. **In `app/(admin)/admin/users/[id]/page.tsx`**:
     - Find the user edit form fields. Add a `userType` dropdown/select after the existing fields (near `companyName` or `industry`).
     - Options: `[{ value: 'team', label: 'Team (Internal)' }, { value: 'client', label: 'Client (Customer)' }]`.
     - Wire it to the existing `updateUserByAdmin()` call which already accepts `userType` in its params (confirmed in `lib/admin/queries.ts` line 165).
     - Include it in the form state and submit payload.

  3. **In `lib/admin/queries.ts`**:
     - Find `getSubscriptionStats()` (or the function that calculates MRR/revenue).
     - Add an optional `userTypeFilter?: string` parameter.
     - When `userTypeFilter` is provided, add `.eq('userType', userTypeFilter)` to the query.
     - Create a helper `getClientOnlyStats()` that calls `getSubscriptionStats({ userTypeFilter: 'client' })`.

  4. **In `app/(admin)/admin/analytics/page.tsx`**:
     - Add a toggle or tab: "All Users" vs "Clients Only" (default to "Clients Only" for revenue metrics).
     - When "Clients Only" is selected, pass the filter to the stats query.
     - Display a note like "Revenue reflects client subscriptions only" when filtered.
     - Keep total usage stats (messages, conversations) unfiltered -- only revenue metrics filter by user type.
  </action>
  <verify>
  - `pnpm lint` passes on all three files.
  - `grep -n "userType" app/(admin)/admin/users/[id]/page.tsx` shows the new dropdown.
  - `grep -n "userTypeFilter\|client" lib/admin/queries.ts` shows filtered query logic.
  - Migration applied: run `execute_sql` with `SELECT column_default FROM information_schema.columns WHERE table_name = 'User' AND column_name = 'userType'` to confirm default is 'client'.
  </verify>
  <done>
  - Admin user detail page has a userType dropdown with "Team" and "Client" options.
  - Existing users with NULL userType are backfilled to "client".
  - New users default to "client".
  - Analytics revenue metrics can be filtered to show client-only revenue.
  </done>
</task>

<task type="auto">
  <name>Task 2: Multi-select reactions system</name>
  <files>app/(chat)/api/reactions/route.ts, lib/db/queries/message.ts, components/message-reactions.tsx</files>
  <action>
  1. **Apply Supabase migration** (project ID: `esymbjpzjjkffpfqukxw`):
     - Add unique constraint: `ALTER TABLE "MessageReaction" ADD CONSTRAINT "MessageReaction_unique_user_reaction" UNIQUE ("messageId", "userId", "reactionType");`
     - This prevents duplicate reaction rows of the same type. Wrap in DO block to handle if constraint already exists.

  2. **In `lib/db/queries/message.ts`**:
     - **`removeMessageReaction()`**: Add a `reactionType` parameter (optional for backward compat). When provided, add `.eq('reactionType', reactionType)` to only delete that specific reaction type. When omitted, keep existing behavior (delete all for user on message).
       ```typescript
       export async function removeMessageReaction({
         messageId,
         userId,
         reactionType,  // NEW: optional
       }: {
         messageId: string;
         userId: string;
         reactionType?: ReactionType;  // NEW
       }) {
         const supabase = await createClient();
         let query = supabase
           .from("MessageReaction")
           .delete()
           .eq("messageId", messageId)
           .eq("userId", userId);
         if (reactionType) {
           query = query.eq("reactionType", reactionType);
         }
         await query;
       }
       ```
     - **`addMessageReaction()`**: Remove the pre-delete step (lines 221-226 that delete existing of same type). The unique constraint handles duplicates. Just insert directly. If the insert fails due to unique violation, catch it silently (it means the reaction already exists -- this is the toggle-off case which should go through `removeMessageReaction` instead).
     - **`getUserReactionForMessage()`**: Return ALL reactions for the user on that message, not just one. Change return type from `MessageReaction | null` to `MessageReaction[]`. Remove `.limit(1)`. Return `data || []`.

  3. **In `app/(chat)/api/reactions/route.ts`**:
     - **POST handler**: Replace the "remove all, then add" logic with toggle logic:
       a. Check if user already has THIS specific reaction type on this message by querying: `getUserReactionsForMessage({ messageId, userId })` and checking if the array includes the requested type.
       b. If already exists: call `removeMessageReaction({ messageId, userId, reactionType })` (toggle OFF).
       c. If not exists: call `addMessageReaction({ messageId, userId, reactionType })` (toggle ON).
       d. Return `{ success: true, action: 'added' | 'removed' }`.
     - **DELETE handler**: Accept `reactionType` in the body. Pass it to `removeMessageReaction()`. If no `reactionType` provided, remove all (backward compat).
     - **GET handler**: Change `userReaction` in the response from a single value to an array. Instead of `userReaction?.reactionType ?? null`, return the full array: `userReactions: reactions.map(r => r.reactionType)` where `reactions` comes from the updated `getUserReactionForMessage()`.

  4. **In `components/message-reactions.tsx`**:
     - Change `userReaction` prop from `ReactionType | null` to `userReactions?: ReactionType[]`.
     - Change `currentReaction` state from `ReactionType | null` to `currentReactions: ReactionType[]` (initialized from `userReactions ?? []`).
     - **`handleReaction()`**: Toggle the reaction type in/out of the array:
       ```typescript
       const isRemoving = currentReactions.includes(reactionType);
       // ... api call (always POST -- server handles toggle) ...
       setCurrentReactions(prev =>
         isRemoving
           ? prev.filter(r => r !== reactionType)
           : [...prev, reactionType]
       );
       ```
     - Always use POST for the API call (server-side toggle). Remove the conditional DELETE path.
     - Update the `isActive` checks: from `currentReaction === type` to `currentReactions.includes(type as ReactionType)`.
     - Update the `isUserReaction` check in active reaction badges similarly.
     - Remove the toast message on reaction change (it's noisy with multi-select -- just show visual feedback via the ring/highlight).
  </action>
  <verify>
  - `pnpm lint` passes on all three files.
  - `grep -n "ReactionType\[\]" components/message-reactions.tsx` confirms array state type.
  - `grep -n "includes(reactionType)" app/(chat)/api/reactions/route.ts` confirms toggle logic.
  - `grep -n "reactionType?" lib/db/queries/message.ts` confirms optional param on removeMessageReaction.
  - Migration applied: run `execute_sql` with `SELECT constraint_name FROM information_schema.table_constraints WHERE table_name = 'MessageReaction' AND constraint_type = 'UNIQUE'` to confirm constraint exists.
  </verify>
  <done>
  - Users can apply multiple reactions to a single message (e.g., both "Actionable" and "Save for Later").
  - Clicking an active reaction toggles it off without affecting other reactions.
  - API uses toggle semantics (POST toggles on/off, no separate DELETE needed for normal use).
  - Unique DB constraint prevents duplicate reaction rows of the same type per user per message.
  - Component renders all active reactions with highlight rings.
  </done>
</task>

</tasks>

<verification>
1. `pnpm lint` passes on all modified files.
2. Admin user page shows userType dropdown and saves correctly.
3. Analytics page shows filtered revenue when "Clients Only" is selected.
4. Reaction component allows selecting multiple reaction types on one message.
5. Clicking same reaction toggles it off; other reactions remain.
6. DB has unique constraint on (messageId, userId, reactionType).
7. Users with NULL userType have been backfilled to "client".
</verification>

<success_criteria>
- Admin can categorize users as "team" or "client" from the user detail page.
- Analytics revenue metrics filter to show client-only subscriptions by default.
- Users can apply multiple reaction types to a single message.
- Toggling a reaction off does not affect other active reactions on the same message.
</success_criteria>

<output>
After completion, create `.planning/phases/15-billing-knowledge-base-platform/15-03-SUMMARY.md`
</output>
