---
phase: 15-billing-knowledge-base-platform
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/stripe/actions.ts
  - app/api/stripe/webhook/route.ts
  - app/(marketing)/pricing/page.tsx
  - components/subscription/paywall-modal.tsx
autonomous: true
user_setup:
  - service: stripe
    why: "Billing portal must have subscription updates enabled"
    dashboard_config:
      - task: "Enable subscription updates in Customer Portal settings"
        location: "Stripe Dashboard > Settings > Customer portal > Subscription updates > Enable"
      - task: "Add all three prices (monthly, annual, lifetime) to the portal product catalog"
        location: "Stripe Dashboard > Settings > Customer portal > Subscription updates > Products"
      - task: "Set proration behavior to 'Create prorations' (immediate)"
        location: "Stripe Dashboard > Settings > Customer portal > Subscription updates > Proration behavior"
      - task: "Copy the portal configuration ID (bpc_xxx) and set it as STRIPE_PORTAL_CONFIG_ID env var"
        location: "Stripe Dashboard > Settings > Customer portal > Configuration ID"
    env_vars:
      - name: STRIPE_PORTAL_CONFIG_ID
        source: "Stripe Dashboard > Settings > Customer portal > Configuration ID (starts with bpc_)"

must_haves:
  truths:
    - "Billing portal session includes a portal configuration ID that enables subscription switching"
    - "Webhook correctly syncs plan changes from customer.subscription.updated events to the User table"
    - "Pricing page shows 'Cancel Anytime' messaging instead of '30-Day Money-Back Guarantee'"
    - "Paywall modal shows 'Cancel anytime' instead of '30-day money-back guarantee'"
  artifacts:
    - path: "lib/stripe/actions.ts"
      provides: "Portal session creation with configuration ID"
      contains: "STRIPE_PORTAL_CONFIG_ID"
    - path: "app/api/stripe/webhook/route.ts"
      provides: "customer.subscription.updated handler that syncs plan type"
      contains: "customer.subscription.updated"
    - path: "app/(marketing)/pricing/page.tsx"
      provides: "Updated guarantee section and FAQ with Cancel Anytime copy"
      contains: "Cancel Anytime"
    - path: "components/subscription/paywall-modal.tsx"
      provides: "Updated footer with Cancel anytime text"
      contains: "Cancel anytime"
  key_links:
    - from: "lib/stripe/actions.ts"
      to: "Stripe billingPortal API"
      via: "configuration parameter in sessions.create()"
      pattern: "configuration.*STRIPE_PORTAL_CONFIG_ID"
    - from: "app/api/stripe/webhook/route.ts"
      to: "lib/stripe/actions.ts"
      via: "activateSubscription call on plan change"
      pattern: "customer\\.subscription\\.updated"
---

<objective>
Configure Stripe billing portal for subscription upgrades/downgrades and update pricing copy from "30-Day Money-Back Guarantee" to "Cancel Anytime".

Purpose: Users on one tier (monthly/annual/lifetime) can switch plans via the Stripe portal instead of contacting support. The pricing page and paywall modal reflect current business policy.
Output: Portal session with upgrade/downgrade UI, webhook handling for plan changes, updated marketing copy.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-billing-knowledge-base-platform/15-RESEARCH.md
@lib/stripe/actions.ts
@lib/stripe/config.ts
@app/api/stripe/webhook/route.ts
@app/(marketing)/pricing/page.tsx
@components/subscription/paywall-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Portal configuration and webhook plan-change handler</name>
  <files>lib/stripe/actions.ts, app/api/stripe/webhook/route.ts</files>
  <action>
  1. In `lib/stripe/actions.ts`, update `createPortalSession()`:
     - Read `process.env.STRIPE_PORTAL_CONFIG_ID` (optional -- if not set, skip passing it, so the portal still works with Stripe's default config).
     - If the env var is set, pass `configuration: process.env.STRIPE_PORTAL_CONFIG_ID` to `getStripe().billingPortal.sessions.create()`.
     - Remove the unused `profile` query (lines 149-153 that fetch `stripeSubscriptionId` but never use it).
     - Keep everything else unchanged.

  2. In `app/api/stripe/webhook/route.ts`, add a `customer.subscription.updated` case:
     - Extract the subscription object from `event.data.object`.
     - Read `userId` from `subscription.metadata.userId`.
     - Read the new price ID from `subscription.items.data[0].price.id`.
     - Map the price ID back to a subscription type by comparing against `STRIPE_PRICES.monthly`, `STRIPE_PRICES.annual`, `STRIPE_PRICES.lifetime`. If no match, log a warning and break.
     - Call `activateSubscription({ userId, subscriptionType, stripeSubscriptionId: subscription.id })` to sync the new plan type to the User table.
     - Log: `[Stripe Webhook] Plan changed to ${subscriptionType} for user ${userId}`.
     - Import `STRIPE_PRICES` from `@/lib/stripe/config` (already imported as `PLAN_DETAILS` -- add `STRIPE_PRICES`).
     - Place this case BEFORE the `customer.subscription.deleted` case in the switch statement.
  </action>
  <verify>
  - `pnpm lint` passes without errors on both files.
  - `grep -n "STRIPE_PORTAL_CONFIG_ID" lib/stripe/actions.ts` shows the env var usage.
  - `grep -n "customer.subscription.updated" app/api/stripe/webhook/route.ts` shows the new case.
  </verify>
  <done>
  - Portal session creation passes configuration ID when env var is set, falls back to default when not.
  - Webhook handles `customer.subscription.updated` by mapping price ID to subscription type and syncing to DB.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace 30-Day Money-Back Guarantee with Cancel Anytime copy</name>
  <files>app/(marketing)/pricing/page.tsx, components/subscription/paywall-modal.tsx</files>
  <action>
  1. In `app/(marketing)/pricing/page.tsx`:
     - **GuaranteeSection** (lines 415-450): Change heading from "30-Day Money-Back Guarantee" to "Cancel Anytime. No Strings Attached." Change the body paragraph to: "Your membership is completely flexible. Cancel anytime with no penalties or hidden fees. We're confident you'll love working with our AI executive team -- and we'll keep earning your business every month."
     - **FAQ** (line 336, the "Can I cancel?" answer): Change from "If you're not satisfied within the first 30 days, we offer a full refund, no questions asked." to "Your subscription is yours to control -- upgrade, downgrade, or cancel whenever you want. No penalties, no hassle."
     - Keep the GuaranteeSection's visual design (dark card, green checkmark icon) unchanged.

  2. In `components/subscription/paywall-modal.tsx`:
     - **Footer** (line 245): Change "30-day money-back guarantee. Cancel anytime." to "Cancel anytime. No strings attached."
  </action>
  <verify>
  - `pnpm lint` passes without errors on both files.
  - `grep -rn "30-Day\|30-day\|money-back\|Money-Back" app/(marketing)/pricing/page.tsx components/subscription/paywall-modal.tsx` returns zero matches.
  - `grep -n "Cancel Anytime\|Cancel anytime" app/(marketing)/pricing/page.tsx components/subscription/paywall-modal.tsx` confirms new copy is present.
  </verify>
  <done>
  - All "30-Day Money-Back Guarantee" references are replaced with "Cancel Anytime" messaging across pricing page and paywall modal.
  - FAQ answer about cancellation reflects flexibility without mentioning refund windows.
  </done>
</task>

</tasks>

<verification>
1. `pnpm lint` passes on all modified files.
2. No references to "30-Day Money-Back" or "30-day money-back" remain in pricing page or paywall modal.
3. Portal session code includes optional `configuration` parameter.
4. Webhook switch statement includes `customer.subscription.updated` handler.
5. `pnpm build` compiles without errors (if env vars are available).
</verification>

<success_criteria>
- Stripe portal sessions can use a configuration ID that enables plan switching (when env var is set).
- Plan changes via Stripe portal are synced to the User table through the webhook.
- All pricing-facing copy uses "Cancel Anytime" language instead of "30-Day Money-Back Guarantee".
</success_criteria>

<output>
After completion, create `.planning/phases/15-billing-knowledge-base-platform/15-01-SUMMARY.md`
</output>
