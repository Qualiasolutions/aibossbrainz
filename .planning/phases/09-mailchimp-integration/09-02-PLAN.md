---
phase: 09-mailchimp-integration
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - app/api/stripe/webhook/route.ts
autonomous: true

must_haves:
  truths:
    - "Trial tag is applied when user starts 7-day trial via Stripe checkout"
    - "Paid tag is applied when invoice is paid (trial-to-paid conversion or direct purchase)"
    - "Mailchimp failure blocks webhook completion with 500 error (strict consistency)"
    - "Plan-specific tags are applied (Monthly vs Full for annual/lifetime)"
  artifacts:
    - path: "app/api/stripe/webhook/route.ts"
      provides: "Stripe webhook with Mailchimp integration"
      contains: "applyTrialTag|applyPaidTag"
  key_links:
    - from: "app/api/stripe/webhook/route.ts"
      to: "lib/mailchimp/tags.ts"
      via: "import applyTrialTag, applyPaidTag"
      pattern: 'import.*from.*lib/mailchimp/tags'
    - from: "app/api/stripe/webhook/route.ts"
      to: "Mailchimp API"
      via: "applyTrialTag/applyPaidTag calls"
      pattern: "await applyTrialTag|await applyPaidTag"
---

<objective>
Integrate Mailchimp tagging into the existing Stripe webhook handler.

Purpose: When users start a trial or complete payment, automatically tag them in Mailchimp for email automation. This connects the platform to Alexandria's trial email sequence.

Output: Stripe webhook applies Mailchimp tags on trial start and payment completion.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-mailchimp-integration/09-CONTEXT.md
@.planning/phases/09-mailchimp-integration/09-01-SUMMARY.md

Reference existing code:
@app/api/stripe/webhook/route.ts - Current webhook handler
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Mailchimp trial tagging to subscription.created webhook</name>
  <files>app/api/stripe/webhook/route.ts</files>
  <action>
In `app/api/stripe/webhook/route.ts`:

1. Add import at top:
```typescript
import { applyTrialTag, applyPaidTag } from "@/lib/mailchimp/tags";
```

2. In the `customer.subscription.created` case, AFTER the `sendTrialStartedEmail` block (around line 90), add Mailchimp tagging:

```typescript
// Apply Mailchimp trial tag (after email verification implied by checkout completion)
if (profile?.email) {
  const mailchimpResult = await applyTrialTag(profile.email);
  if (!mailchimpResult.success) {
    // Per CONTEXT.md: block user action on Mailchimp failure (strict consistency)
    console.error(
      `[Stripe Webhook] Mailchimp trial tagging failed, blocking: ${mailchimpResult.error}`,
    );
    return NextResponse.json(
      { error: "Failed to complete signup - please try again" },
      { status: 500 },
    );
  }
}
```

IMPORTANT: Place this inside the `if (subscription.status === "trialing")` block, after the email send attempt.

The blocking behavior is per CONTEXT.md decision: "On Mailchimp API failure: Block the user action (strict consistency)"
  </action>
  <verify>
Run: `grep -A5 "applyTrialTag" app/api/stripe/webhook/route.ts` - shows trial tag call with error handling
Run: `pnpm exec tsc --noEmit` - no type errors
  </verify>
  <done>
- applyTrialTag is called after trial starts
- Webhook returns 500 if Mailchimp tagging fails (blocks Stripe retry)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Mailchimp paid tagging to invoice.paid webhook</name>
  <files>app/api/stripe/webhook/route.ts</files>
  <action>
In the `invoice.paid` case, AFTER the `activateSubscription` call (around line 145), add Mailchimp paid tagging:

1. Get the user's email (need to fetch profile):
```typescript
// Apply Mailchimp paid tag for plan type
try {
  const profile = await getUserFullProfile({ userId });
  if (profile?.email && subscriptionType) {
    const mailchimpResult = await applyPaidTag(profile.email, subscriptionType);
    if (!mailchimpResult.success) {
      console.error(
        `[Stripe Webhook] Mailchimp paid tagging failed, blocking: ${mailchimpResult.error}`,
      );
      return NextResponse.json(
        { error: "Failed to complete payment processing - please contact support" },
        { status: 500 },
      );
    }
  }
} catch (profileError) {
  console.error(
    "[Stripe Webhook] Failed to fetch profile for Mailchimp tagging:",
    profileError,
  );
  // Don't block payment for profile fetch failure - Mailchimp will retry
}
```

2. Place this INSIDE the `if (userId && subscriptionType)` block, after `activateSubscription` and BEFORE the annual/lifetime cancel logic.

NOTE: The paid tag triggers automation exit in Mailchimp. Per CONTEXT.md:
- Monthly: "AI Boss Brainz Monthly" tag
- Annual/Lifetime: "AI Boss Brainz Full" tag
  </action>
  <verify>
Run: `grep -A5 "applyPaidTag" app/api/stripe/webhook/route.ts` - shows paid tag call
Run: `grep -c "mailchimp" app/api/stripe/webhook/route.ts` - should show multiple matches
Run: `pnpm exec tsc --noEmit` - no type errors
  </verify>
  <done>
- applyPaidTag is called when invoice is paid (trial conversion or direct purchase)
- Plan-specific tags are applied (monthly vs full)
- Webhook returns 500 if Mailchimp tagging fails
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `pnpm exec tsc --noEmit` passes without errors
2. `pnpm build` succeeds
3. Webhook imports applyTrialTag and applyPaidTag from lib/mailchimp/tags
4. Trial tagging happens in customer.subscription.created handler
5. Paid tagging happens in invoice.paid handler
6. Both failures block webhook completion with 500 (strict consistency)
</verification>

<success_criteria>
- Stripe webhook imports and calls Mailchimp tag functions
- Trial tag applied when subscription created with trialing status
- Paid tag applied when invoice paid with userId and subscriptionType
- Mailchimp failures block webhook completion (Stripe will retry)
- No type errors, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/09-mailchimp-integration/09-02-SUMMARY.md`
</output>
