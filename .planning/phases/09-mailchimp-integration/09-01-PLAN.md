---
phase: 09-mailchimp-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
  - lib/mailchimp/client.ts
  - lib/mailchimp/tags.ts
  - lib/email/admin-notifications.ts
  - .env.example
autonomous: true
user_setup:
  - service: mailchimp
    why: "Mailchimp Marketing API for trial/paid tagging"
    env_vars:
      - name: MAILCHIMP_API_KEY
        source: "Mailchimp Dashboard -> Account & billing -> Extras -> API keys"
      - name: MAILCHIMP_SERVER_PREFIX
        source: "From API key (part after dash, e.g., 'us5')"
      - name: MAILCHIMP_AUDIENCE_ID
        source: "Audience -> Settings -> Audience name and defaults (d5fc73df51)"

must_haves:
  truths:
    - "Mailchimp SDK is installed and TypeScript types work"
    - "Mailchimp client initializes lazily without crashing when env vars missing"
    - "applyTrialTag function can tag a contact with the trial tag"
    - "applyPaidTag function can tag a contact with plan-specific paid tag"
    - "Admin notification sends email when Mailchimp operation fails"
  artifacts:
    - path: "lib/mailchimp/client.ts"
      provides: "Mailchimp client initialization and tag constants"
      exports: ["getMailchimpClient", "MAILCHIMP_TAGS", "MAILCHIMP_AUDIENCE_ID"]
    - path: "lib/mailchimp/tags.ts"
      provides: "Tag application functions with retry and error handling"
      exports: ["applyTrialTag", "applyPaidTag", "getSubscriberHash"]
    - path: "lib/email/admin-notifications.ts"
      provides: "Generic admin alert function via Resend"
      exports: ["sendAdminNotification"]
  key_links:
    - from: "lib/mailchimp/tags.ts"
      to: "lib/mailchimp/client.ts"
      via: "import getMailchimpClient, MAILCHIMP_TAGS"
      pattern: "import.*from.*client"
    - from: "lib/mailchimp/tags.ts"
      to: "lib/email/admin-notifications.ts"
      via: "import sendAdminNotification"
      pattern: "import.*admin-notifications"
---

<objective>
Create the Mailchimp client module with tag application functions and admin notification helper.

Purpose: Establish the foundation for Mailchimp integration - client initialization, tag operations, and error notification. This module follows existing patterns from lib/stripe/ and lib/email/.

Output: Complete lib/mailchimp/ module ready for use by Stripe webhook handlers.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-mailchimp-integration/09-CONTEXT.md
@.planning/phases/09-mailchimp-integration/09-RESEARCH.md

Reference patterns:
@lib/stripe/config.ts - Lazy client initialization pattern
@lib/email/support-notifications.ts - Resend email pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Mailchimp SDK and TypeScript types</name>
  <files>package.json, pnpm-lock.yaml</files>
  <action>
Install the official Mailchimp Marketing SDK and TypeScript definitions:

```bash
pnpm add @mailchimp/mailchimp_marketing
pnpm add -D @types/mailchimp__mailchimp_marketing
```

After installation, verify the packages appear in package.json:
- `@mailchimp/mailchimp_marketing` in dependencies
- `@types/mailchimp__mailchimp_marketing` in devDependencies
  </action>
  <verify>
Run: `grep -E "mailchimp" package.json` - should show both packages
Run: `pnpm exec tsc --noEmit` - should pass without mailchimp type errors
  </verify>
  <done>Mailchimp SDK installed with TypeScript types, no build errors</done>
</task>

<task type="auto">
  <name>Task 2: Create Mailchimp client module with tag application functions</name>
  <files>lib/mailchimp/client.ts, lib/mailchimp/tags.ts</files>
  <action>
Create `lib/mailchimp/client.ts`:
- Follow lazy initialization pattern from lib/stripe/config.ts
- Export `getMailchimpClient()` that returns configured client or null if env vars missing
- Export `MAILCHIMP_TAGS` constant with exact tag names from CONTEXT.md:
  - TRIAL: "7-Day Free Trial: AI Boss Brainz"
  - PAID_MONTHLY: "AI Boss Brainz Monthly"
  - PAID_ANNUAL_OR_LIFETIME: "AI Boss Brainz Full"
- Export `MAILCHIMP_AUDIENCE_ID` from env with fallback to "d5fc73df51"
- Log warning when API key not configured (don't throw)

Create `lib/mailchimp/tags.ts`:
- Import from `node:crypto` for MD5 hash (NOT from crypto package)
- Export `getSubscriberHash(email: string): string` - MD5 of lowercase email
- Export `applyTrialTag(email: string): Promise<{ success: boolean; error?: string }>`
  - Use setListMember to upsert contact with status_if_new: "subscribed"
  - Apply trial tag via updateListMemberTags
  - Implement 3 retries with exponential backoff (500ms, 1s, 2s) before failing
  - On failure: call sendAdminNotification and return error
  - Log success with "[Mailchimp]" prefix
- Export `applyPaidTag(email: string, subscriptionType: "monthly" | "annual" | "lifetime"): Promise<{ success: boolean; error?: string }>`
  - Map subscriptionType to correct tag (monthly -> PAID_MONTHLY, annual/lifetime -> PAID_ANNUAL_OR_LIFETIME)
  - Same upsert + tag pattern as applyTrialTag
  - Same retry and error handling pattern

Per CONTEXT.md decisions:
- Block on Mailchimp failure (strict consistency) - return success: false
- Keep trial tag when user upgrades (don't remove, just add paid tag)
  </action>
  <verify>
Run: `pnpm exec tsc --noEmit` - no type errors
Run: `grep -l "getMailchimpClient\|applyTrialTag\|applyPaidTag" lib/mailchimp/*.ts` - files exist with exports
  </verify>
  <done>
- lib/mailchimp/client.ts exports getMailchimpClient, MAILCHIMP_TAGS, MAILCHIMP_AUDIENCE_ID
- lib/mailchimp/tags.ts exports applyTrialTag, applyPaidTag, getSubscriberHash
- Functions handle errors gracefully with retry logic
  </done>
</task>

<task type="auto">
  <name>Task 3: Create admin notification helper and update env example</name>
  <files>lib/email/admin-notifications.ts, .env.example</files>
  <action>
Create `lib/email/admin-notifications.ts`:
- Follow pattern from lib/email/support-notifications.ts
- Export `sendAdminNotification({ subject: string, message: string }): Promise<void>`
- Send to ADMIN_EMAIL constant: "info@qualiasolutions.net"
- Use FROM_EMAIL from env or fallback to "Alecci Media AI <noreply@resend.dev>"
- Prefix subject with "[Alert]"
- Format message with simple HTML (replace \n with <br />)
- Silently log warning if RESEND_API_KEY not configured (don't throw)

Update `.env.example` (or create if missing):
Add these new env vars with comments:

```bash
# Mailchimp Marketing API (required for trial/paid tagging)
# Get your key at: https://mailchimp.com/account/api/
# Format: apikey-datacenter (e.g., abc123-us5)
MAILCHIMP_API_KEY=
# Server prefix extracted from API key (the part after the dash)
MAILCHIMP_SERVER_PREFIX=us5
# Audience ID for "Alecci Media" list
MAILCHIMP_AUDIENCE_ID=d5fc73df51
```
  </action>
  <verify>
Run: `pnpm exec tsc --noEmit` - no type errors
Run: `grep "sendAdminNotification" lib/email/admin-notifications.ts` - function exists
Run: `grep "MAILCHIMP" .env.example || grep "MAILCHIMP" .env.local.example` - env vars documented
  </verify>
  <done>
- lib/email/admin-notifications.ts exports sendAdminNotification
- .env.example documents all Mailchimp env vars with instructions
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `pnpm exec tsc --noEmit` passes without errors
2. `pnpm build` succeeds (no build-time errors from missing env vars)
3. lib/mailchimp/ directory exists with client.ts and tags.ts
4. lib/email/admin-notifications.ts exists
5. .env.example includes Mailchimp configuration section
</verification>

<success_criteria>
- Mailchimp SDK installed and types work
- Client module initializes lazily without crashing on missing env vars
- Tag functions implement retry logic and admin notification on failure
- Admin notification helper follows existing Resend patterns
- Build passes without the env vars set (lazy init handles this)
</success_criteria>

<output>
After completion, create `.planning/phases/09-mailchimp-integration/09-01-SUMMARY.md`
</output>
