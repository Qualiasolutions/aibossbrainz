---
phase: 09-mailchimp-integration
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - app/api/admin/mailchimp/backfill/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin endpoint exists at /api/admin/mailchimp/backfill"
    - "Endpoint is protected - only admins can access"
    - "Endpoint tags all existing verified trial users with trial tag"
    - "Endpoint returns progress info (total, success, failed counts)"
  artifacts:
    - path: "app/api/admin/mailchimp/backfill/route.ts"
      provides: "Admin backfill endpoint for existing trial users"
      exports: ["POST"]
  key_links:
    - from: "app/api/admin/mailchimp/backfill/route.ts"
      to: "lib/mailchimp/tags.ts"
      via: "import applyTrialTag"
      pattern: 'import.*from.*lib/mailchimp/tags'
    - from: "app/api/admin/mailchimp/backfill/route.ts"
      to: "lib/db/queries.ts or direct Supabase"
      via: "query trial users"
      pattern: "trialing|trial"
---

<objective>
Create an admin endpoint to backfill Mailchimp trial tags for existing verified trial users.

Purpose: When the Mailchimp integration deploys, existing trial users won't have tags. This endpoint allows Alexandria to manually trigger a one-time backfill to tag all current trial users so they enter the email automation.

Output: Protected admin endpoint that tags existing trial users in Mailchimp.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-mailchimp-integration/09-CONTEXT.md
@.planning/phases/09-mailchimp-integration/09-01-SUMMARY.md

Reference existing admin patterns:
@app/api/admin/ - Existing admin API routes for auth pattern
@lib/db/queries.ts - Database query patterns
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin backfill endpoint for Mailchimp trial tags</name>
  <files>app/api/admin/mailchimp/backfill/route.ts</files>
  <action>
Create `app/api/admin/mailchimp/backfill/route.ts`:

1. Follow existing admin route patterns for authentication check
2. Query all users where:
   - `subscriptionStatus` = "trialing"
   - `email` is not null (verified)
   - `emailVerified` = true (if field exists, otherwise just check email not null)

3. For each user:
   - Call `applyTrialTag(user.email)`
   - Track success/failure counts
   - Add small delay between calls (100ms) to respect rate limits

4. Return JSON response with:
   - `total`: number of users processed
   - `success`: count of successful tags
   - `failed`: count of failed tags
   - `errors`: array of { email, error } for failed ones

Implementation:
```typescript
import { NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";
import { applyTrialTag } from "@/lib/mailchimp/tags";

export async function POST(request: Request) {
  // Check admin auth
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  // Check if user is admin (query User table for isAdmin field)
  const { data: profile } = await supabase
    .from("User")
    .select("isAdmin")
    .eq("id", user.id)
    .single();

  if (!profile?.isAdmin) {
    return NextResponse.json({ error: "Forbidden - Admin only" }, { status: 403 });
  }

  // Query all trial users with verified emails
  const { data: trialUsers, error: queryError } = await supabase
    .from("User")
    .select("id, email")
    .eq("subscriptionStatus", "trialing")
    .not("email", "is", null);

  if (queryError) {
    console.error("[Backfill] Failed to query trial users:", queryError);
    return NextResponse.json(
      { error: "Failed to query users" },
      { status: 500 },
    );
  }

  if (!trialUsers || trialUsers.length === 0) {
    return NextResponse.json({
      total: 0,
      success: 0,
      failed: 0,
      message: "No trial users to backfill",
    });
  }

  // Process each user with small delay
  const results = {
    total: trialUsers.length,
    success: 0,
    failed: 0,
    errors: [] as { email: string; error: string }[],
  };

  for (const trialUser of trialUsers) {
    if (!trialUser.email) continue;

    const result = await applyTrialTag(trialUser.email);

    if (result.success) {
      results.success++;
    } else {
      results.failed++;
      results.errors.push({
        email: trialUser.email,
        error: result.error || "Unknown error",
      });
    }

    // Small delay to respect Mailchimp rate limits
    await new Promise((resolve) => setTimeout(resolve, 100));
  }

  console.log(
    `[Backfill] Completed: ${results.success}/${results.total} users tagged`,
  );

  return NextResponse.json(results);
}
```

IMPORTANT: This is a one-time backfill endpoint. It's safe to run multiple times (Mailchimp tags are idempotent).
  </action>
  <verify>
Run: `pnpm exec tsc --noEmit` - no type errors
Run: `ls app/api/admin/mailchimp/backfill/route.ts` - file exists
Run: `grep "isAdmin" app/api/admin/mailchimp/backfill/route.ts` - admin check exists
  </verify>
  <done>
- Admin endpoint exists at /api/admin/mailchimp/backfill
- Endpoint requires admin authentication
- Queries all trialing users with email
- Applies trial tag to each user
- Returns progress counts and error details
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `pnpm exec tsc --noEmit` passes without errors
2. `pnpm build` succeeds
3. Endpoint file exists at app/api/admin/mailchimp/backfill/route.ts
4. Admin check prevents unauthorized access
5. Endpoint queries trialing users and tags them
</verification>

<success_criteria>
- Admin backfill endpoint created and protected
- Endpoint queries existing trial users from database
- Each trial user gets tagged in Mailchimp
- Response includes success/failure counts for monitoring
- Idempotent - safe to run multiple times
</success_criteria>

<output>
After completion, create `.planning/phases/09-mailchimp-integration/09-03-SUMMARY.md`
</output>
