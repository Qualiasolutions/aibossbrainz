---
phase: 11-critical-fixes-auth-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(auth)/actions.ts
  - components/password-input.tsx
  - components/auth-form.tsx
  - app/(auth)/reset-password/page.tsx
  - app/(auth)/signup/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can sign up without hitting a runtime error from undefined headersList variable"
    - "User can request a password reset without hitting a runtime error from undefined headersList variable"
    - "Password validation enforces minimum 8 characters everywhere (Zod schemas, HTML minLength, toast messages)"
    - "Password fields on login, signup, and reset-password pages show a clickable eye icon to toggle visibility"
  artifacts:
    - path: "app/(auth)/actions.ts"
      provides: "Fixed rate-limit variable names (headersList) and min(8) Zod schemas"
      contains: "headersList"
    - path: "components/password-input.tsx"
      provides: "Reusable password input with show/hide toggle"
      exports: ["PasswordInput"]
    - path: "components/auth-form.tsx"
      provides: "Auth form using PasswordInput instead of plain Input for password field"
      contains: "PasswordInput"
    - path: "app/(auth)/reset-password/page.tsx"
      provides: "Reset password page using PasswordInput and minLength={8}"
      contains: "PasswordInput"
    - path: "app/(auth)/signup/page.tsx"
      provides: "Signup page with corrected error toast text (min 8 characters)"
      contains: "min 8 characters"
  key_links:
    - from: "components/password-input.tsx"
      to: "components/ui/input.tsx"
      via: "wraps Input with toggle state"
      pattern: "import.*Input.*from.*ui/input"
    - from: "components/auth-form.tsx"
      to: "components/password-input.tsx"
      via: "uses PasswordInput for password field"
      pattern: "import.*PasswordInput"
    - from: "app/(auth)/reset-password/page.tsx"
      to: "components/password-input.tsx"
      via: "uses PasswordInput for both password fields"
      pattern: "import.*PasswordInput"
---

<objective>
Fix the auth rate-limiting crash (BUG-01), enforce consistent 8-character password minimum (AUTH-02), and add show/hide toggle to all password fields (AUTH-01).

Purpose: Sign up and password reset are completely broken in production due to a variable name typo. This plan fixes that critical bug and delivers the two password UX improvements.
Output: Working auth actions, consistent password validation, and a reusable PasswordInput component used across all auth pages.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-critical-fixes-auth-hardening/11-RESEARCH.md

@app/(auth)/actions.ts
@components/auth-form.tsx
@components/ui/input.tsx
@app/(auth)/reset-password/page.tsx
@app/(auth)/signup/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix auth rate-limit variable bug and password min length</name>
  <files>app/(auth)/actions.ts</files>
  <action>
  Fix BUG-01: In the `signup` function (line 108), the variable is declared as `const requestHeaders = await headers()` but lines 110-113 reference `headersList` (which is undefined, crashing the function). Rename `requestHeaders` to `headersList` on line 108 to match the usage pattern from the `login` function. Apply the identical fix in the `requestPasswordReset` function (line 176) where the same `requestHeaders` vs `headersList` mismatch exists.

  Fix AUTH-02: Change all three Zod `.min(6)` calls to `.min(8)`:
  - Line 10: `authFormSchema` password field — change `.min(6)` to `.min(8)`
  - Line 18: `passwordResetSchema` password field — change `.min(6)` to `.min(8)`
  - Line 19: `passwordResetSchema` confirmPassword field — change `.min(6)` to `.min(8)`

  Do NOT change any other logic in the file. The login function already uses `headersList` correctly — leave it alone.
  </action>
  <verify>Run `pnpm build` — the file must compile without errors. Grep the file: `headersList` should appear 3 times (login, signup, requestPasswordReset), `requestHeaders` should appear 0 times. All `.min(` calls on password fields should show `min(8)`.</verify>
  <done>Signup and password-reset rate limiting use the correct `headersList` variable. All Zod password schemas enforce min 8 characters.</done>
</task>

<task type="auto">
  <name>Task 2: Create PasswordInput component and integrate into all auth pages</name>
  <files>components/password-input.tsx, components/auth-form.tsx, app/(auth)/reset-password/page.tsx, app/(auth)/signup/page.tsx</files>
  <action>
  Create `components/password-input.tsx`:
  - A "use client" component that wraps the existing `Input` from `components/ui/input.tsx`
  - Accepts all props that `Input` accepts (extend `React.ComponentProps<"input">`)
  - Manages internal `showPassword` boolean state (default false)
  - Renders the Input with `type={showPassword ? "text" : "password"}`
  - Appends a clickable button (not a real `<button>` to avoid form submission — use a `<div role="button" tabIndex={0}>`) inside a relative wrapper, positioned absolute right-3, vertically centered
  - Use `Eye` and `EyeOff` icons from `lucide-react` (already installed), size 16, text-stone-400 hover:text-stone-600 transition-colors
  - The wrapper div should be `relative` so the icon positions correctly over the input
  - Add `pr-10` to the input className to make room for the icon
  - Export as named export `PasswordInput`

  Update `components/auth-form.tsx`:
  - Replace `import { Input } from "./ui/input"` with `import { PasswordInput } from "./password-input"`
  - Replace the password `<Input>` (lines 48-56) with `<PasswordInput>` keeping all existing props. Change `autoComplete` to `"current-password"` (already is). Keep `type="password"` OFF since PasswordInput manages type internally.
  - Do NOT touch the email Input — only the password field

  Update `app/(auth)/reset-password/page.tsx`:
  - Add import for `PasswordInput` from `@/components/password-input`
  - Replace both `<Input type="password">` elements (New Password on line 180 and Confirm Password on line 199) with `<PasswordInput>`. Remove the `type="password"` prop since PasswordInput handles it internally.
  - Fix the Confirm Password `minLength={6}` on line 207 to `minLength={8}` to match the New Password field
  - Remove the `Input` import if no longer used (it is not used elsewhere in this file)

  Update `app/(auth)/signup/page.tsx`:
  - Line 60: Change the toast text from `"min 6 characters"` to `"min 8 characters"` — full string should be: `"Please enter a valid email and password (min 8 characters)."`
  - No other changes needed in this file (it uses AuthForm which we already updated)
  </action>
  <verify>Run `pnpm build` — all files compile. Run `pnpm lint` — no linting errors. Visually verify by running `pnpm dev` and visiting `/login`, `/signup`, and `/reset-password` — each password field should show an eye icon that toggles visibility.</verify>
  <done>All password fields across login, signup, and reset-password pages have a show/hide toggle icon. Confirm password field enforces minLength 8. Signup toast says "min 8 characters".</done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero errors
2. `pnpm lint` passes
3. In `app/(auth)/actions.ts`: grep confirms `headersList` appears in all three auth functions, no `requestHeaders` references remain
4. In `app/(auth)/actions.ts`: all password `.min()` calls use `8`
5. `components/password-input.tsx` exists and exports `PasswordInput`
6. All three auth pages render password fields with eye toggle icon
7. `minLength={8}` on both fields in reset-password page
8. Signup toast text includes "min 8 characters"
</verification>

<success_criteria>
- BUG-01: `signup` and `requestPasswordReset` functions no longer crash from undefined variable reference
- AUTH-02: Password minimum length is consistently 8 across Zod schemas, HTML validation, and user-facing toast messages
- AUTH-01: Every password field on login, signup, and reset-password pages has a working show/hide toggle
</success_criteria>

<output>
After completion, create `.planning/phases/11-critical-fixes-auth-hardening/11-01-SUMMARY.md`
</output>
