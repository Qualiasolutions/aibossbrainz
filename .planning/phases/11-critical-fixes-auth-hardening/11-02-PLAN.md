---
phase: 11-critical-fixes-auth-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - components/chat.tsx
  - app/(chat)/api/chat/route.ts
  - hooks/use-auto-resume.ts
autonomous: true

must_haves:
  truths:
    - "When AI generation fails, user sees a friendly retry toast instead of a raw error or silent failure"
    - "After an error, user can type and send a new message without refreshing the page"
    - "User can navigate to a different chat or create a new chat even when current chat had an error"
    - "Returning to a previous chat shows the full conversation history (no blank screen from failed resumeStream)"
  artifacts:
    - path: "components/chat.tsx"
      provides: "Error handler that catches all error types, shows toast, calls clearError to reset status"
      contains: "clearError"
    - path: "app/(chat)/api/chat/route.ts"
      provides: "Improved server-side error message for stream failures"
      contains: "Something went wrong"
    - path: "hooks/use-auto-resume.ts"
      provides: "Safe resumeStream with try/catch to prevent blank screens"
      contains: "try"
  key_links:
    - from: "components/chat.tsx"
      to: "@ai-sdk/react useChat"
      via: "destructures clearError from useChat return value"
      pattern: "clearError"
    - from: "components/chat.tsx"
      to: "components/toast"
      via: "shows error toast for all error types"
      pattern: "toast.*error"
    - from: "hooks/use-auto-resume.ts"
      to: "components/chat.tsx"
      via: "called with resumeStream from useChat"
      pattern: "resumeStream"
---

<objective>
Fix chat error recovery (BUG-02, BUG-03) so users see friendly error messages and can continue chatting after failures, and fix conversation loading (BUG-04) so returning to a chat never shows a blank screen.

Purpose: Generation errors currently leave the chat in a stuck "error" state where the user cannot send new messages or start new chats without refreshing. And `resumeStream` can throw on stale/missing streams, causing blank screens.
Output: Resilient chat error handling with `clearError()`, improved server error message, and safe auto-resume.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-critical-fixes-auth-hardening/11-RESEARCH.md

@components/chat.tsx
@app/(chat)/api/chat/route.ts
@hooks/use-auto-resume.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix chat error recovery with clearError and improved error handling</name>
  <files>components/chat.tsx, app/(chat)/api/chat/route.ts</files>
  <action>
  In `components/chat.tsx`:

  1. Destructure `clearError` from the `useChat` hook return value (line ~137-205). Add it alongside `messages`, `setMessages`, `sendMessage`, `status`, `stop`, `regenerate`, `resumeStream`. The AI SDK v5.0.118 `useChat` returns `clearError: () => void`.

  2. Rewrite the `onError` handler (lines 185-204) to handle ALL error types, not just `ChatSDKError`:
     ```
     onError: (error) => {
       // Restore last sent message to input for retry
       if (lastSentMessage) {
         const text = lastSentMessage.parts
           .filter((p) => p.type === "text")
           .map((p) => p.text)
           .join("");
         setInput(text);
       }

       // Show user-friendly message for ALL error types
       const message = error instanceof ChatSDKError
         ? error.message
         : "Something went wrong generating a response. Please try again.";

       toast({
         type: "error",
         description: `${message} Your message has been restored in the input field.`,
       });

       // Clear stored message after handling
       setLastSentMessage(null);

       // Reset status from "error" to "ready" so user can send new messages (BUG-03 fix)
       clearError();
     },
     ```

  The key changes from current code:
  - Remove the `if (error instanceof ChatSDKError)` guard — handle ALL errors
  - Add a fallback message for non-ChatSDKError errors (BUG-02)
  - Call `clearError()` at the end to reset `status` from `"error"` to `"ready"` (BUG-03)

  Note: `clearError` is referenced inside the `onError` callback which is defined in the same object as the `useChat` call. This works because `clearError` is captured in the closure — the `useChat` hook returns a stable reference.

  In `app/(chat)/api/chat/route.ts`:

  Update the `onError` callback (line 468-471) to return a more helpful message:
  ```
  onError: () => {
    apiLog.warn("Stream onError callback triggered");
    return "Something went wrong generating a response. Please try again.";
  },
  ```
  Change `"Oops, an error occurred!"` to `"Something went wrong generating a response. Please try again."` — this is the message that gets sent back to the client as the error text.
  </action>
  <verify>Run `pnpm build` — must compile without errors. Run `pnpm lint` — no linting issues. Verify `clearError` appears in chat.tsx. Verify the `onError` in chat.tsx has no `if (error instanceof ChatSDKError)` guard wrapping the main logic.</verify>
  <done>All generation errors show a user-friendly retry toast. After any error, the chat status resets to "ready" so users can send new messages, start new chats, or navigate without being stuck.</done>
</task>

<task type="auto">
  <name>Task 2: Add try/catch to auto-resume to prevent blank screens</name>
  <files>hooks/use-auto-resume.ts</files>
  <action>
  In `hooks/use-auto-resume.ts`, wrap the `resumeStream()` call (line 31) in a try/catch block:

  ```typescript
  if (mostRecentMessage?.role === "user") {
    try {
      resumeStream();
    } catch (error) {
      console.warn("Failed to resume stream, displaying existing messages:", error);
      // Don't rethrow — the existing messages from initialMessages will display normally
      // This handles the case where resumable streams are disabled on the server
      // but autoResume is true on the client
    }
  }
  ```

  The issue: The chat route has resumable streams commented out (lines 474-482 in route.ts), but the client-side `autoResume={true}` still triggers `resumeStream()`. When there's no resumable stream to connect to, this can throw and cause a blank screen. The try/catch ensures the conversation history from `initialMessages` still renders even if resume fails.

  Do NOT change any other logic in this file. The second `useEffect` (dataStream handler) should remain untouched.
  </action>
  <verify>Run `pnpm build` — file compiles. Grep `hooks/use-auto-resume.ts` for `try` to confirm the try/catch is present. Navigate to an existing chat — conversation history should load fully (not blank).</verify>
  <done>Returning to any previous chat shows the full conversation content. Failed `resumeStream()` calls are caught silently and the existing message history displays normally.</done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero errors
2. `pnpm lint` passes
3. `components/chat.tsx` contains `clearError` destructured from `useChat`
4. `components/chat.tsx` `onError` handles all error types (no `instanceof ChatSDKError` guard on the main logic)
5. `components/chat.tsx` `onError` calls `clearError()` to reset status
6. `app/(chat)/api/chat/route.ts` `onError` returns a user-friendly message
7. `hooks/use-auto-resume.ts` has try/catch around `resumeStream()`
</verification>

<success_criteria>
- BUG-02: Any generation failure shows "Something went wrong generating a response. Please try again." toast with message restored in input
- BUG-03: After an error, chat status is "ready" — user can send new messages, navigate to other chats, or create new chats without refreshing
- BUG-04: Returning to a previous chat always shows full conversation history, even when resumeStream fails
</success_criteria>

<output>
After completion, create `.planning/phases/11-critical-fixes-auth-hardening/11-02-SUMMARY.md`
</output>
