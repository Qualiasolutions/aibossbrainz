---
phase: 26-documentation-design-decisions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/ai/prompts.ts
  - app/(chat)/api/csrf/route.ts
  - app/(chat)/api/subscription/route.ts
  - app/api/stripe/webhook/route.ts
  - app/(chat)/api/chat/route.ts
  - components/chat.tsx
  - app/(chat)/api/voice/route.ts
  - CLAUDE.md
  - vercel.json
autonomous: true

must_haves:
  truths:
    - "Code comments explain WHY updateDocumentPrompt uses lighter sanitization for code content"
    - "Code comments explain WHY the CSRF endpoint is unauthenticated"
    - "Code comments explain WHY subscription GET returns graceful empty response for unauthenticated users"
    - "Code comments explain WHY payment failure only logs and defers admin notification"
    - "Code comments explain that stream recovery requires REDIS_URL and degrades silently without it"
    - "Code comments explain WHY focus mode is client-state only and persistence is deferred"
    - "Code comments explain WHY voice cost uses estimated minutes not character-level tracking"
    - "CLAUDE.md focus modes list matches actual implementation in lib/bot-personalities.ts"
    - "CLAUDE.md has Design Decisions section documenting intentional trade-offs"
    - "CLAUDE.md Environment Variables section documents REDIS_URL enables resumable streams"
    - "vercel.json includes X-XSS-Protection: 0 header per OWASP recommendation"
  artifacts:
    - path: "lib/ai/prompts.ts"
      provides: "DESIGN(DOC-01) comment on updateDocumentPrompt"
      contains: "DESIGN(DOC-01)"
    - path: "app/(chat)/api/csrf/route.ts"
      provides: "DESIGN(DOC-02) comment on unauthenticated CSRF endpoint"
      contains: "DESIGN(DOC-02)"
    - path: "app/(chat)/api/subscription/route.ts"
      provides: "DESIGN(DOC-03) comment on graceful unauthenticated response"
      contains: "DESIGN(DOC-03)"
    - path: "app/api/stripe/webhook/route.ts"
      provides: "DESIGN(DOC-04) comment on payment failure handling"
      contains: "DESIGN(DOC-04)"
    - path: "app/(chat)/api/chat/route.ts"
      provides: "DESIGN(DOC-05) comment on stream recovery Redis requirement"
      contains: "DESIGN(DOC-05)"
    - path: "components/chat.tsx"
      provides: "DESIGN(DOC-06) comment on focus mode client-state"
      contains: "DESIGN(DOC-06)"
    - path: "app/(chat)/api/voice/route.ts"
      provides: "DESIGN(DOC-10) comment on voice cost estimation"
      contains: "DESIGN(DOC-10)"
    - path: "CLAUDE.md"
      provides: "Corrected focus modes, Design Decisions section, updated env var docs"
      contains: "Design Decisions"
    - path: "vercel.json"
      provides: "X-XSS-Protection: 0 header"
      contains: "X-XSS-Protection"
  key_links:
    - from: "CLAUDE.md"
      to: "lib/bot-personalities.ts"
      via: "Focus modes list accuracy"
      pattern: "business_analysis.*pricing.*key_messaging.*customer_journey.*social_media.*launch_strategy"
---

<objective>
Document all 10 informational audit findings (DOC-01 through DOC-10) as intentional design decisions with inline code comments, update CLAUDE.md with corrected focus modes and a Design Decisions section, and add the X-XSS-Protection: 0 header to vercel.json.

Purpose: Close the final phase of v1.4 audit remediation by documenting WHY intentional trade-offs were made, so future developers and auditors understand design rationale without re-investigating.

Output: Inline DESIGN(DOC-XX) comments in 7 source files, updated CLAUDE.md, updated vercel.json.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-documentation-design-decisions/26-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add inline DESIGN comments to 7 source files and X-XSS-Protection header</name>
  <files>
    lib/ai/prompts.ts
    app/(chat)/api/csrf/route.ts
    app/(chat)/api/subscription/route.ts
    app/api/stripe/webhook/route.ts
    app/(chat)/api/chat/route.ts
    components/chat.tsx
    app/(chat)/api/voice/route.ts
    vercel.json
  </files>
  <action>
    Add DESIGN(DOC-XX) comments at the exact decision points in each file. Comments must explain WHY, not WHAT. Keep each comment to 1-3 lines. Do NOT change any code logic -- comments only (plus one vercel.json header).

    **lib/ai/prompts.ts** -- Above the `updateDocumentPrompt` function (around line 276):
    ```
    // DESIGN(DOC-01): Code content uses XML wrapper only, not full sanitizePromptContent().
    // Aggressive sanitization mangles code delimiters (```, ===, ---) which are valid code.
    // The XML do_not_follow_instructions_in_content attribute provides injection protection.
    ```

    **app/(chat)/api/csrf/route.ts** -- Above the GET handler (around line 15):
    ```
    // DESIGN(DOC-02): This endpoint is intentionally unauthenticated. CSRF tokens must be
    // available before auth (subscribe page, login forms). Security relies on the double-submit
    // pattern: HMAC-signed token must match in both httpOnly cookie and request header.
    ```

    **app/(chat)/api/subscription/route.ts** -- Above the `if (authError || !user)` block (around line 88):
    ```
    // DESIGN(DOC-03): Returns graceful empty response instead of 401 for unauthenticated users.
    // The subscribe page polls this endpoint after Stripe checkout to detect subscription activation.
    // During this window, the auth session may not be established yet -- a 401 would break the flow.
    ```

    **app/api/stripe/webhook/route.ts** -- Above the `invoice.payment_failed` case (around line 510):
    ```
    // DESIGN(DOC-04): Only logs warning, no user/admin notification. Stripe handles user-facing
    // dunning emails natively. Custom emails would duplicate and potentially conflict with Stripe's
    // retry communications. Admin payment failure dashboard deferred to v2.
    ```

    **app/(chat)/api/chat/route.ts** -- Above the `getStreamContext` function (around line 106):
    ```
    // DESIGN(DOC-05): Resumable streams require REDIS_URL. Without Redis, stream recovery
    // degrades silently -- interrupted streams cannot be resumed. The app functions normally
    // (streams just aren't resumable). This is an acceptable degradation for environments
    // without Redis.
    ```

    **components/chat.tsx** -- Above the focusMode useState (around line 127):
    ```
    // DESIGN(DOC-06): Focus mode is intentionally client-state only (resets on page reload).
    // It's a session-level preference, not critical data. Persistence (localStorage or DB)
    // deferred to v2 pending user feedback.
    ```

    **app/(chat)/api/voice/route.ts** -- Above the first `estimatedMinutes` calculation (around line 220, or the comment at line 317-318):
    ```
    // DESIGN(DOC-10): Voice cost tracked as estimated minutes (chars / 750), not character-level.
    // ElevenLabs bills per character but actual costs are monitored via their dashboard.
    // Character-level cost tracking with AICostLog integration deferred to v2.
    ```
    Add this comment once near the first occurrence of estimatedMinutes calculation. No need to repeat at every calculation site.

    **vercel.json** -- Add `X-XSS-Protection: 0` header to the main `/(.*)`  headers array, after the existing `X-Frame-Options` entry (around line 44):
    ```json
    {
      "key": "X-XSS-Protection",
      "value": "0"
    }
    ```
    This disables the deprecated XSS Auditor in legacy browsers per OWASP recommendation. CSP already provides XSS protection.
  </action>
  <verify>
    Run `grep -rn "DESIGN(DOC-" lib/ai/prompts.ts app/\(chat\)/api/csrf/route.ts app/\(chat\)/api/subscription/route.ts app/api/stripe/webhook/route.ts app/\(chat\)/api/chat/route.ts components/chat.tsx app/\(chat\)/api/voice/route.ts` and confirm 7 distinct DOC tags (DOC-01, DOC-02, DOC-03, DOC-04, DOC-05, DOC-06, DOC-10).

    Run `grep "X-XSS-Protection" vercel.json` and confirm the header exists with value "0".

    Run `pnpm build` to confirm no syntax errors were introduced.
  </verify>
  <done>
    All 7 source files contain DESIGN(DOC-XX) comments explaining the WHY of each design decision. vercel.json contains X-XSS-Protection: 0 header. Build passes with no errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CLAUDE.md with corrected focus modes, Design Decisions section, and env var docs</name>
  <files>CLAUDE.md</files>
  <action>
    Three changes to CLAUDE.md. No other files.

    **1. Fix focus modes (DOC-07)** -- Replace line 53:
    ```
    Focus modes: `default`, `brand_crisis`, `launch_campaign`, `pipeline_audit`, `deal_closing`, `market_entry`, `team_scaling`
    ```
    With:
    ```
    Focus modes: `default`, `business_analysis`, `pricing`, `key_messaging`, `customer_journey`, `social_media`, `launch_strategy`

    Note: `social_media` is only available for `alexandria` and `collaborative` (not `kim`).
    ```

    **2. Update Environment Variables section (DOC-05, DOC-08)** -- In the Optional env vars section (around line 128), update the REDIS_URL description:
    ```
    - `REDIS_URL` - Rate limiting (falls back to DB) + resumable stream recovery (without Redis, interrupted streams cannot be resumed)
    ```

    Also add a note after the `NEXT_PUBLIC_SUPABASE_ANON_KEY` entry (around line 120-121):
    ```
    - `NEXT_PUBLIC_SUPABASE_URL` - Supabase project URL (intentionally client-exposed; security relies on RLS, not ID obscurity)
    - `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Supabase anon key (intentionally client-exposed; RLS enforces access control)
    ```

    **3. Add Design Decisions section (DOC-02, DOC-04, DOC-06, DOC-08, DOC-09, DOC-10)** -- Add a new section after "### Security Patterns" and before "### Streaming PII Scan Limitation":

    ```markdown
    ### Design Decisions (Audit Acknowledgements)

    These patterns were reviewed during the AI Production Audit and confirmed as intentional. Each has a `// DESIGN(DOC-XX)` comment at the code decision point.

    #### CSRF Token Endpoint Unauthenticated (DOC-02)
    **Decision:** `/api/csrf` serves tokens without requiring authentication.
    **Rationale:** CSRF tokens must be available before auth completes (subscribe page during checkout, login forms). The double-submit pattern (HMAC-signed token in httpOnly cookie + request header) provides security independent of auth state.

    #### Subscription GET Graceful Degradation (DOC-03)
    **Decision:** `GET /api/subscription` returns `{ isActive: false }` for unauthenticated users instead of 401.
    **Rationale:** The subscribe page polls this endpoint after Stripe checkout. During the webhook-to-auth race window, a 401 would break the payment completion flow.

    #### Payment Failure Notifications (DOC-04)
    **Decision:** `invoice.payment_failed` webhook logs a warning only -- no user or admin notification.
    **Rationale:** Stripe handles user-facing dunning (retry emails) automatically. Custom notifications would duplicate and potentially conflict. Admin payment failure dashboard deferred to v2.

    #### Focus Mode Client-State Only (DOC-06)
    **Decision:** Focus mode is `useState` only -- resets on page reload, not persisted.
    **Rationale:** Focus mode is a session-level preference. Persistence (localStorage or per-chat DB column) deferred to v2 pending user feedback.

    #### Supabase ID Exposure (DOC-08)
    **Decision:** Supabase project ID and anon key are intentionally in `NEXT_PUBLIC_` environment variables.
    **Rationale:** Standard Supabase architecture. Security relies on Row-Level Security (RLS) policies on every table, not obscurity of the project ID or anon key.

    #### X-XSS-Protection Disabled (DOC-09)
    **Decision:** `X-XSS-Protection: 0` set in `vercel.json` instead of enabling it.
    **Rationale:** The XSS Auditor is deprecated and removed from all modern browsers. Setting it to `1` can create side-channel data leak vulnerabilities in legacy browsers (per OWASP). CSP provides actual XSS protection.

    #### ElevenLabs Cost Estimation (DOC-10)
    **Decision:** Voice cost tracked as estimated minutes (`chars / 750`), not exact character-level billing.
    **Rationale:** Provides directional usage data. Actual ElevenLabs costs monitored via their dashboard. Rate limiting (500 voice requests/day for regular users) provides cost protection. Character-level tracking with `AICostLog` integration deferred to v2.
    ```
  </action>
  <verify>
    Run `grep "business_analysis" CLAUDE.md` to confirm focus modes are corrected (DOC-07).

    Run `grep "Design Decisions" CLAUDE.md` to confirm the new section exists.

    Run `grep "resumable stream" CLAUDE.md` to confirm REDIS_URL documentation updated (DOC-05).

    Run `grep "RLS, not ID obscurity" CLAUDE.md` or `grep "intentionally client-exposed" CLAUDE.md` to confirm Supabase ID acknowledgement (DOC-08).

    Verify all 10 DOC requirements are addressed:
    - DOC-01: Inline comment (Task 1)
    - DOC-02: Inline comment (Task 1) + CLAUDE.md section (Task 2)
    - DOC-03: Inline comment (Task 1) + CLAUDE.md section (Task 2)
    - DOC-04: Inline comment (Task 1) + CLAUDE.md section (Task 2)
    - DOC-05: Inline comment (Task 1) + CLAUDE.md env var update (Task 2)
    - DOC-06: Inline comment (Task 1) + CLAUDE.md section (Task 2)
    - DOC-07: CLAUDE.md focus modes fix (Task 2)
    - DOC-08: CLAUDE.md env var note + section (Task 2)
    - DOC-09: vercel.json header (Task 1) + CLAUDE.md section (Task 2)
    - DOC-10: Inline comment (Task 1) + CLAUDE.md section (Task 2)
  </verify>
  <done>
    CLAUDE.md focus modes match actual implementation. Design Decisions section documents 7 intentional trade-offs with rationale. Environment Variables section documents REDIS_URL stream recovery and Supabase ID exposure. All 10 DOC requirements are covered across Task 1 and Task 2.
  </done>
</task>

</tasks>

<verification>
All 10 DOC requirements addressed:

| Requirement | Inline Comment | CLAUDE.md | vercel.json |
|-------------|---------------|-----------|-------------|
| DOC-01 | lib/ai/prompts.ts | -- | -- |
| DOC-02 | app/(chat)/api/csrf/route.ts | Design Decisions section | -- |
| DOC-03 | app/(chat)/api/subscription/route.ts | Design Decisions section | -- |
| DOC-04 | app/api/stripe/webhook/route.ts | Design Decisions section | -- |
| DOC-05 | app/(chat)/api/chat/route.ts | Env vars section | -- |
| DOC-06 | components/chat.tsx | Design Decisions section | -- |
| DOC-07 | -- | Focus modes line corrected | -- |
| DOC-08 | -- | Env vars + Design Decisions | -- |
| DOC-09 | -- | Design Decisions section | X-XSS-Protection: 0 |
| DOC-10 | app/(chat)/api/voice/route.ts | Design Decisions section | -- |

Run `pnpm build` to confirm no syntax errors.
Run `grep -rn "DESIGN(DOC-" .` to confirm all inline comments present.
</verification>

<success_criteria>
1. Seven source files contain `// DESIGN(DOC-XX)` comments explaining design rationale
2. CLAUDE.md focus modes list exactly matches `lib/bot-personalities.ts` FocusMode type
3. CLAUDE.md contains "Design Decisions (Audit Acknowledgements)" section with 7 entries
4. CLAUDE.md env vars section documents REDIS_URL stream recovery and Supabase ID intent
5. vercel.json contains `X-XSS-Protection: 0` header in the main headers array
6. `pnpm build` passes with no errors
7. All 10 DOC requirements (DOC-01 through DOC-10) are addressed
</success_criteria>

<output>
After completion, create `.planning/phases/26-documentation-design-decisions/26-01-SUMMARY.md`
</output>
