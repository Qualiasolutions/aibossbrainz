---
phase: 20-observability-cost-controls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/cost/tracker.ts
  - supabase/migrations/20260218000100_add_ai_cost_log.sql
  - app/(chat)/api/chat/route.ts
  - app/api/stripe/webhook/route.ts
  - app/api/cron/cost-check/route.ts
  - app/(chat)/api/admin-costs/route.ts
  - vercel.json
  - lib/supabase/middleware.ts
autonomous: true

must_haves:
  truths:
    - "Stripe webhook handler uses structured logger.* calls with request IDs -- no console.log remaining"
    - "Every AI chat response log entry includes inputTokens, outputTokens, model ID, and estimated cost in USD"
    - "When daily AI spend crosses a configurable threshold, an admin notification email is sent"
    - "A monthly cost API endpoint aggregates token-to-dollar conversion across all users"
  artifacts:
    - path: "lib/cost/tracker.ts"
      provides: "Cost recording and daily aggregation functions"
      exports: ["recordAICost", "getDailyAICostTotal", "getMonthlyCostSummary"]
    - path: "app/api/cron/cost-check/route.ts"
      provides: "Daily cost aggregation cron with threshold alerting"
      exports: ["GET"]
    - path: "app/(chat)/api/admin-costs/route.ts"
      provides: "Monthly cost dashboard API endpoint"
      exports: ["GET"]
    - path: "app/api/stripe/webhook/route.ts"
      provides: "Stripe webhook with all console.* replaced by structured logger"
  key_links:
    - from: "app/(chat)/api/chat/route.ts"
      to: "lib/cost/tracker.ts"
      via: "recordAICost() in after() callback"
      pattern: "recordAICost"
    - from: "app/api/cron/cost-check/route.ts"
      to: "lib/cost/tracker.ts"
      via: "getDailyAICostTotal()"
      pattern: "getDailyAICostTotal"
    - from: "app/api/cron/cost-check/route.ts"
      to: "lib/email/admin-notifications.ts"
      via: "sendAdminNotification()"
      pattern: "sendAdminNotification"
---

<objective>
Build AI cost tracking infrastructure, wire cost recording into the chat route, migrate Stripe webhook to structured logging, create daily cost alerting cron, and expose monthly cost dashboard API.

Purpose: Enables cost visibility and spend control for AI operations (OBS-01, OBS-03, COST-01, COST-02)
Output: Cost tracker module, AICostLog table, cost cron job, cost dashboard endpoint, fully migrated Stripe webhook
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-observability-cost-controls/20-RESEARCH.md

@lib/logger.ts
@lib/api-logging.ts
@lib/email/admin-notifications.ts
@lib/analytics/queries.ts
@lib/usage.ts
@app/(chat)/api/chat/route.ts
@app/api/stripe/webhook/route.ts
@app/api/cron/expire-subscriptions/route.ts
@vercel.json
@lib/supabase/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AICostLog table and cost tracker module</name>
  <files>
    lib/cost/tracker.ts
    supabase/migrations/20260218000100_add_ai_cost_log.sql
  </files>
  <action>
1. **Create migration file** `supabase/migrations/20260218000100_add_ai_cost_log.sql` with the SQL below, then **apply it** via MCP `apply_migration` (project ID: `esymbjpzjjkffpfqukxw`):

```sql
CREATE TABLE IF NOT EXISTS "AICostLog" (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    "userId" TEXT NOT NULL REFERENCES "User"(id) ON DELETE CASCADE,
    "chatId" TEXT REFERENCES "Chat"(id) ON DELETE SET NULL,
    "modelId" TEXT NOT NULL,
    "inputTokens" INTEGER NOT NULL DEFAULT 0,
    "outputTokens" INTEGER NOT NULL DEFAULT 0,
    "costUSD" NUMERIC(10, 8) NOT NULL DEFAULT 0,
    "createdAt" TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_aicostlog_createdat ON "AICostLog"("createdAt");
CREATE INDEX idx_aicostlog_date ON "AICostLog"(DATE("createdAt"));

ALTER TABLE "AICostLog" ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Service role full access" ON "AICostLog"
    FOR ALL USING (auth.role() = 'service_role');
```

2. **Create `lib/cost/tracker.ts`** with three functions:

- `recordAICost(record)`: Inserts a row into AICostLog via `createServiceClient()`. Takes `{ userId, chatId, modelId, inputTokens, outputTokens, costUSD }`. Wraps in try/catch -- logs warning on failure but never throws (non-blocking). Uses `logger.debug()` for successful recording.

- `getDailyAICostTotal(date?: Date)`: Queries AICostLog for a single date (defaults to today). Returns `{ totalCostUSD: number, totalInputTokens: number, totalOutputTokens: number, uniqueUsers: number, requestCount: number }`. Uses `createServiceClient()`. Filters by `DATE("createdAt") = date`.

- `getMonthlyCostSummary(year: number, month: number)`: Queries AICostLog for a month range. Returns same shape as daily but aggregated over the month. Also includes per-model breakdown as `byModel: Array<{ modelId, totalCostUSD, requestCount }>`.

Import `logger` from `@/lib/logger` and `createServiceClient` from `@/lib/supabase/server`. Mark file with `import "server-only"`.
  </action>
  <verify>
Run `grep -c "recordAICost\|getDailyAICostTotal\|getMonthlyCostSummary" lib/cost/tracker.ts` -- should return 3+ (exports + usages). Verify `ls supabase/migrations/*cost_log*` returns the migration file. Verify the migration was applied via MCP.
  </verify>
  <done>AICostLog table exists in Supabase with RLS enabled. Migration SQL file exists at `supabase/migrations/20260218000100_add_ai_cost_log.sql`. Cost tracker module exports three functions for recording and querying cost data.</done>
</task>

<task type="auto">
  <name>Task 2: Wire cost recording into chat route and migrate Stripe webhook logging</name>
  <files>
    app/(chat)/api/chat/route.ts
    app/api/stripe/webhook/route.ts
  </files>
  <action>
**A. Chat route cost recording (OBS-03):**

In `app/(chat)/api/chat/route.ts`, in the `createUIMessageStream` `onFinish` callback, after the existing `recordAnalytics(user.id, "token", totalTokens)` call (~line 506), add cost recording:

```typescript
import { recordAICost } from "@/lib/cost/tracker";

// Inside onFinish, after the totalTokens > 0 check:
if (totalTokens > 0) {
  const costUSD = finalMergedUsage?.costUSD?.totalUSD ?? 0;
  after(() => recordAICost({
    userId: user.id,
    chatId: id,
    modelId: (finalMergedUsage as AppUsage & { modelId?: string })?.modelId ?? selectedChatModel,
    inputTokens,
    outputTokens,
    costUSD,
  }));
}
```

The `costUSD` is already available in `finalMergedUsage` because `getUsage()` from tokenlens returns `{ costUSD?: TokenCosts }` which gets spread into `finalMergedUsage`. Access it via `finalMergedUsage?.costUSD?.totalUSD`.

Also add a structured log line for the AI response:

```typescript
logger.info({
  chatId: id,
  modelId: (finalMergedUsage as AppUsage & { modelId?: string })?.modelId ?? selectedChatModel,
  inputTokens,
  outputTokens,
  costUSD: finalMergedUsage?.costUSD?.totalUSD ?? 0,
}, "AI response completed");
```

Also migrate ALL 5 remaining `console.warn` calls in this file to `logger.warn()`:
- Line ~89: `console.warn("TokenLens: catalog fetch failed...")` → `logger.warn({ err }, "TokenLens catalog fetch failed, using default catalog")`
- Line ~248: `console.warn("Background title generation failed:", err)` → `logger.warn({ err }, "Background title generation failed")`
- Line ~393: `console.warn("TokenLens enrichment failed", err)` → `logger.warn({ err }, "TokenLens enrichment failed")`
- Line ~509: `console.warn("Unable to persist last usage for chat", id, err)` → `logger.warn({ err, chatId: id }, "Unable to persist last usage for chat")`
- Line ~540: `console.warn("Failed to generate conversation summary:", err)` → `logger.warn({ err, chatId: id }, "Failed to generate conversation summary")`

All 5 must be replaced. Zero `console.*` calls should remain in this file.

**B. Stripe webhook structured logging (OBS-01):**

In `app/api/stripe/webhook/route.ts`, replace ALL 33 `console.log/error/warn` calls with structured logging:

1. Import at top: `import { createRequestLogger } from "@/lib/logger";`

2. At the start of the POST handler (after getting the event), create a request logger:
```typescript
const reqLog = createRequestLogger(event.id, userId);
// For early errors before event is parsed, use the base logger:
import { logger } from "@/lib/logger";
```

For pre-event-parse errors (missing webhook secret, signature failure), use `logger.error(...)` since there's no event.id yet.

3. Replace every `console.*` call:

Pattern mapping:
- `console.log("[Stripe Webhook] Processing event: ...")` → `reqLog.info({ eventType: event.type }, "Processing Stripe webhook event")`
- `console.error("[Stripe Webhook] ...")` → `reqLog.error({ ... }, "message")` with Error objects using `{ err: error }` pattern for proper stack traces
- `console.warn(...)` → `reqLog.warn({ ... }, "message")`
- `console.log("[Stripe Webhook] Activated ...")` → `reqLog.info({ subscriptionType, eventType: event.type }, "Subscription activated")`
- Security warnings like `console.error("[SECURITY]...")` → `logger.error({ userId, subscriptionType: session.metadata?.subscriptionType }, "Invalid subscriptionType in checkout metadata")`

For `after()` callback errors, use `logger.error({ err, phase: "after" }, "message")` since the reqLog child logger may not be accessible in the async context.

4. Ensure EVERY `console.log`, `console.error`, `console.warn` in this file is replaced. There should be zero `console.*` calls remaining.
  </action>
  <verify>
Run `grep -c "console\." app/api/stripe/webhook/route.ts` -- must return 0. Run `grep -c "console\." app/\(chat\)/api/chat/route.ts` -- must return 0. Run `grep -c "recordAICost" app/\(chat\)/api/chat/route.ts` -- must return 1+. Run `grep -c "logger\.\|reqLog\." app/api/stripe/webhook/route.ts` -- must return 20+.
  </verify>
  <done>Chat route logs AI response with inputTokens, outputTokens, modelId, costUSD and records cost to AICostLog table. Stripe webhook has zero console.* calls -- all replaced with structured logger with request IDs and event context.</done>
</task>

<task type="auto">
  <name>Task 3: Create cost alerting cron and monthly cost dashboard API</name>
  <files>
    app/api/cron/cost-check/route.ts
    app/(chat)/api/admin-costs/route.ts
    vercel.json
    lib/supabase/middleware.ts
  </files>
  <action>
**A. Daily cost check cron (COST-01):**

Create `app/api/cron/cost-check/route.ts` following the pattern from `app/api/cron/expire-subscriptions/route.ts`:

```typescript
import { type NextRequest, NextResponse } from "next/server";
import { getDailyAICostTotal } from "@/lib/cost/tracker";
import { sendAdminNotification } from "@/lib/email/admin-notifications";
import { logger } from "@/lib/logger";

const DAILY_COST_THRESHOLD_USD = Number(process.env.AI_DAILY_COST_THRESHOLD_USD) || 10;

export async function GET(request: NextRequest) {
  const authHeader = request.headers.get("authorization");
  const cronSecret = process.env.CRON_SECRET;

  if (!cronSecret || authHeader !== `Bearer ${cronSecret}`) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  try {
    const daily = await getDailyAICostTotal();

    logger.info({
      totalCostUSD: daily.totalCostUSD,
      requestCount: daily.requestCount,
      uniqueUsers: daily.uniqueUsers,
    }, "Daily AI cost check completed");

    if (daily.totalCostUSD > DAILY_COST_THRESHOLD_USD) {
      await sendAdminNotification({
        subject: `AI Daily Spend Alert: $${daily.totalCostUSD.toFixed(4)}`,
        message: `Daily AI spend ($${daily.totalCostUSD.toFixed(4)}) exceeded threshold ($${DAILY_COST_THRESHOLD_USD}).\n\nRequests: ${daily.requestCount}\nUnique users: ${daily.uniqueUsers}\nInput tokens: ${daily.totalInputTokens}\nOutput tokens: ${daily.totalOutputTokens}`,
        type: "alert",
      });
      logger.warn({
        dailyCost: daily.totalCostUSD,
        threshold: DAILY_COST_THRESHOLD_USD,
      }, "AI daily cost threshold exceeded - admin notified");
    }

    return NextResponse.json({
      success: true,
      ...daily,
      thresholdUSD: DAILY_COST_THRESHOLD_USD,
      thresholdExceeded: daily.totalCostUSD > DAILY_COST_THRESHOLD_USD,
      timestamp: new Date().toISOString(),
    });
  } catch (error) {
    logger.error({ err: error }, "Daily cost check cron failed");
    return NextResponse.json({ error: "Failed to check costs" }, { status: 500 });
  }
}
```

**B. Monthly cost dashboard API (COST-02):**

Create `app/(chat)/api/admin-costs/route.ts`:

```typescript
import { NextResponse } from "next/server";
import { getMonthlyCostSummary } from "@/lib/cost/tracker";
import { isUserAdmin } from "@/lib/admin/queries";
import { createClient } from "@/lib/supabase/server";
import { logger } from "@/lib/logger";

export async function GET(request: Request) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const admin = await isUserAdmin(user.id);
  if (!admin) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const url = new URL(request.url);
  const year = Number(url.searchParams.get("year")) || new Date().getFullYear();
  const month = Number(url.searchParams.get("month")) || new Date().getMonth() + 1;

  try {
    const summary = await getMonthlyCostSummary(year, month);
    return NextResponse.json(summary);
  } catch (error) {
    logger.error({ err: error }, "Failed to get monthly cost summary");
    return NextResponse.json({ error: "Failed to get cost data" }, { status: 500 });
  }
}
```

**C. Register cron in vercel.json:**

Add the cost-check cron to the `crons` array in `vercel.json`:
```json
{
  "path": "/api/cron/cost-check",
  "schedule": "0 23 * * *"
}
```

Run at 23:00 UTC daily (near end of day to capture most of the day's spend).

**D. Update middleware allowlist:**

The `/api/cron/` prefix in `publicApiRoutes` in `lib/supabase/middleware.ts` already covers `/api/cron/cost-check` (it uses startsWith matching). No change needed to middleware.

The admin-costs endpoint is under `app/(chat)/` which is an authenticated route group -- no middleware change needed.

Verify middleware covers the cron route by checking `publicApiRoutes` includes `"/api/cron/"`.
  </action>
  <verify>
Verify files exist: `ls app/api/cron/cost-check/route.ts app/\(chat\)/api/admin-costs/route.ts`. Verify cron registered: `grep "cost-check" vercel.json`. Verify no console.* in new files: `grep -c "console\." app/api/cron/cost-check/route.ts app/\(chat\)/api/admin-costs/route.ts` -- both must return 0.
  </verify>
  <done>Cost cron runs daily at 23:00 UTC, aggregates daily spend, and emails admin when spend exceeds AI_DAILY_COST_THRESHOLD_USD (default $10). Monthly cost API at /api/admin-costs returns aggregated cost data with per-model breakdown, accessible to admin users only.</done>
</task>

</tasks>

<verification>
1. `grep -rn "console\." app/api/stripe/webhook/route.ts` returns nothing (OBS-01)
2. `grep -rn "console\." app/\(chat\)/api/chat/route.ts` returns nothing
3. `grep "recordAICost" app/\(chat\)/api/chat/route.ts` shows cost recording wired into chat route (OBS-03)
4. `grep "costUSD\|inputTokens\|outputTokens\|modelId" app/\(chat\)/api/chat/route.ts` shows all four fields logged (OBS-03)
5. `grep "sendAdminNotification" app/api/cron/cost-check/route.ts` shows alerting connected (COST-01)
6. `grep "getMonthlyCostSummary" app/\(chat\)/api/admin-costs/route.ts` shows monthly aggregation (COST-02)
7. `grep "cost-check" vercel.json` shows cron registered
8. No `console.*` in any newly created files
</verification>

<success_criteria>
- Stripe webhook has zero console.* calls, fully migrated to structured logger with request IDs (OBS-01)
- Chat route logs AI response with inputTokens, outputTokens, modelId, costUSD and persists to AICostLog (OBS-03)
- Daily cost cron sends admin email when threshold exceeded (COST-01)
- Monthly cost endpoint returns aggregated data with per-model breakdown (COST-02)
</success_criteria>

<output>
After completion, create `.planning/phases/20-observability-cost-controls/20-01-SUMMARY.md`
</output>
