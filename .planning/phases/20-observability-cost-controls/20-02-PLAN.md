---
phase: 20-observability-cost-controls
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - app/auth/callback/route.ts
  - lib/stripe/actions.ts
  - lib/db/support-queries.ts
  - app/(auth)/actions.ts
  - lib/email/mandrill.ts
  - lib/analytics/queries.ts
  - app/(chat)/api/realtime/stream/route.ts
  - app/(chat)/api/reactions/route.ts
  - app/api/admin/knowledge-base/fireflies/route.ts
  - app/(chat)/api/history/route.ts
  - app/(chat)/api/canvas/route.ts
  - app/(chat)/api/voice/route.ts
  - app/(chat)/api/document/route.ts
  - app/(chat)/api/vote/route.ts
  - app/(chat)/api/support/route.ts
  - app/(chat)/api/support/[ticketId]/route.ts
  - app/(chat)/api/support/[ticketId]/messages/route.ts
  - app/(chat)/api/accept-tos/route.ts
  - app/(chat)/api/csrf/route.ts
  - app/(chat)/api/subscription/route.ts
  - app/(chat)/api/export-user-data/route.ts
  - app/(chat)/api/analytics/route.ts
  - app/(chat)/api/realtime/route.ts
  - app/(chat)/actions.ts
  - app/api/stripe/portal/route.ts
  - app/api/demo/chat/route.ts
  - app/api/cron/expire-subscriptions/route.ts
  - app/api/admin/mailchimp/backfill/route.ts
  - app/api/admin/landing-page/route.ts
  - lib/cms/landing-page.ts
  - lib/resilience.ts
  - lib/email/admin-notifications.ts
  - lib/mailchimp/tags.ts
  - lib/mailchimp/client.ts
  - lib/stripe/url.ts
  - lib/security/csrf.ts
  - lib/security/rate-limiter.ts
  - lib/audit/logger.ts
  - lib/ai/conversation-summarizer.ts
  - lib/ai/prompts.ts
  - lib/ai/providers.ts
  - lib/ai/tools/strategy-canvas.ts
  - lib/db/queries/executive.ts
  - lib/admin/queries.ts
  - artifacts/text/server.ts
  - artifacts/sheet/server.ts
  - artifacts/code/server.ts
autonomous: true

must_haves:
  truths:
    - "At least 80% of all logging calls across the codebase use structured logger.* instead of console.log/error/warn"
    - "Stack traces in error paths use structured logger.error({ err }) pattern for proper serialization"
    - "Client-side components retain their console.* calls unchanged"
  artifacts:
    - path: "app/auth/callback/route.ts"
      provides: "Auth callback with structured logging"
    - path: "lib/stripe/actions.ts"
      provides: "Stripe actions with structured logging"
    - path: "lib/db/support-queries.ts"
      provides: "Support queries with structured logging"
  key_links:
    - from: "all migrated server files"
      to: "lib/logger.ts"
      via: "import { logger } from '@/lib/logger'"
      pattern: "import.*logger.*from.*@/lib/logger"
---

<objective>
Migrate all remaining server-side console.log/error/warn calls to structured logger.* calls, achieving the 80% structured logging target across the codebase.

Purpose: Complete the structured logging migration (OBS-02, OBS-04) for production log aggregation and debugging
Output: All server-side files use structured pino logging; client components unchanged
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-observability-cost-controls/20-01-SUMMARY.md

@lib/logger.ts
@lib/api-logging.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate high-priority server files to structured logging</name>
  <files>
    app/auth/callback/route.ts
    lib/stripe/actions.ts
    lib/db/support-queries.ts
    app/(auth)/actions.ts
    lib/email/mandrill.ts
    lib/analytics/queries.ts
    lib/email/admin-notifications.ts
    lib/resilience.ts
    lib/audit/logger.ts
    lib/ai/conversation-summarizer.ts
    lib/ai/prompts.ts
    lib/ai/providers.ts
    lib/ai/tools/strategy-canvas.ts
    lib/security/csrf.ts
    lib/security/rate-limiter.ts
    lib/stripe/url.ts
    lib/mailchimp/tags.ts
    lib/mailchimp/client.ts
    lib/cms/landing-page.ts
    lib/db/queries/executive.ts
    lib/admin/queries.ts
    artifacts/text/server.ts
    artifacts/sheet/server.ts
    artifacts/code/server.ts
  </files>
  <action>
Migrate ALL `console.log`, `console.error`, `console.warn` calls in the listed server-side files to use structured `logger.*` from `@/lib/logger`.

**For each file:**
1. Add `import { logger } from "@/lib/logger";` at the top (if not already imported)
2. Replace each `console.*` call following these patterns:

**Pattern mapping:**

- `console.log("[Tag] message", data)` → `logger.info({ ...contextData }, "message")`
- `console.error("[Tag] message:", error)` → `logger.error({ err: error, ...context }, "message")`
  - IMPORTANT: Use `{ err: error }` key for Error objects so pino serializes stack traces properly
  - Never pass Error as the message string
- `console.warn("[Tag] message")` → `logger.warn({ ...context }, "message")`

**File-specific guidance:**

- **`app/auth/callback/route.ts`** (10 calls): Create a request logger for the callback handler. Replace all `console.log/error` with structured logs. Include `code`, `plan`, `next` in context objects where applicable.

- **`lib/stripe/actions.ts`** (8 calls): Replace `console.error` calls. Include `userId`, `subscriptionType`, `stripeSubscriptionId` in context.

- **`lib/db/support-queries.ts`** (8 calls): Replace `console.error` with `logger.error({ err: error }, "message")`. Don't log sensitive ticket content.

- **`app/(auth)/actions.ts`** (7 calls): Replace auth action logging. Keep user context (email domain only, not full email).

- **`lib/email/mandrill.ts`** (6 calls): Replace with structured logger. Include `to` (masked), `subject` in context.

- **`lib/analytics/queries.ts`** (5 calls): Replace `console.error` in catch blocks.

- **`lib/resilience.ts`** (2 calls): Replace with `logger.warn/error`.

- **`lib/audit/logger.ts`** (2 calls): Replace internal `console.error` with `logger.error`.

- **Remaining lib/ files** (1-2 calls each): Straightforward replacement.

- **`artifacts/*.ts`** (3 files): These are server-only artifact handlers. Replace `console.error` with `logger.error`.

**DO NOT touch:**
- Any file with `"use client"` directive
- `instrumentation.ts` / `instrumentation-client.ts` (special Sentry/Next.js files)
- `scripts/` directory (development scripts, not production code)
- `lib/audio-manager.ts` (browser-only utility)
- `lib/utils.ts` (may be imported in client components)
  </action>
  <verify>
For each modified file, run `grep -c "console\." {file}` and verify it returns 0. Count total structured logger imports: `grep -rl "from.*@/lib/logger" lib/ app/ artifacts/ --include="*.ts" | wc -l` -- should be significantly higher than before.
  </verify>
  <done>All high-priority server files (24 files, ~70 console.* calls) migrated to structured logging with proper error serialization patterns.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate remaining server route handlers and verify 80% target</name>
  <files>
    app/(chat)/api/realtime/stream/route.ts
    app/(chat)/api/reactions/route.ts
    app/api/admin/knowledge-base/fireflies/route.ts
    app/(chat)/api/history/route.ts
    app/(chat)/api/canvas/route.ts
    app/(chat)/api/voice/route.ts
    app/(chat)/api/document/route.ts
    app/(chat)/api/vote/route.ts
    app/(chat)/api/support/route.ts
    app/(chat)/api/support/[ticketId]/route.ts
    app/(chat)/api/support/[ticketId]/messages/route.ts
    app/(chat)/api/accept-tos/route.ts
    app/(chat)/api/csrf/route.ts
    app/(chat)/api/subscription/route.ts
    app/(chat)/api/export-user-data/route.ts
    app/(chat)/api/analytics/route.ts
    app/(chat)/api/realtime/route.ts
    app/(chat)/actions.ts
    app/api/stripe/portal/route.ts
    app/api/demo/chat/route.ts
    app/api/cron/expire-subscriptions/route.ts
    app/api/admin/mailchimp/backfill/route.ts
    app/api/admin/landing-page/route.ts
  </files>
  <action>
Migrate ALL remaining server-side `console.log/error/warn` calls in route handlers to structured logging.

**For each file:**
1. Add `import { logger } from "@/lib/logger";` at the top
2. Replace `console.*` calls using the same patterns as Task 1

**File-specific notes:**

- **`app/(chat)/api/realtime/stream/route.ts`** (4 calls): Replace with `logger.info/error/warn`. Include `chatId`, `botType` in context.

- **`app/(chat)/api/reactions/route.ts`** (4 calls): Replace. Include `messageId`, `reaction` in context.

- **`app/api/admin/knowledge-base/fireflies/route.ts`** (4 calls): Replace. Include `transcriptId` in context.

- **`app/(chat)/api/history/route.ts`** (3 calls): Replace.

- **`app/(chat)/api/canvas/route.ts`** (3 calls): Replace.

- **`app/(chat)/api/voice/route.ts`** (3 calls): Replace.

- **`app/(chat)/api/support/route.ts`** (3 calls): Replace.

- **`app/(chat)/api/document/route.ts`** (3 calls): Replace.

- **`app/api/cron/expire-subscriptions/route.ts`** (2 calls): Replace with `logger.info/error`.

- **Remaining route files** (1-2 calls each): Straightforward replacement.

After ALL migrations, verify the 80% target:

**Verification math:**
- Total `console.*` calls before migration: ~201 across 58 .ts files
- Client-side calls (keep as-is): ~20-30 calls across hooks, components with `"use client"`, instrumentation files, scripts, lib/utils.ts, lib/audio-manager.ts
- Server-side calls to migrate: ~170-180
- Plan 01 migrated: ~38 calls (webhook 33 + chat route 5)
- Plan 02 Task 1 migrated: ~70 calls
- Plan 02 Task 2 migrated: ~60 calls
- Remaining client console.*: ~30
- Total structured logger calls after: existing 37 + migrated ~168 = ~205
- Percentage: 205 / (205 + 30) = ~87% → exceeds 80% target

Run a final count to confirm:
```bash
# Count remaining console.* in server .ts files (excluding client components, scripts, instrumentation)
grep -rn "console\.\(log\|error\|warn\)" --include="*.ts" app/ lib/ artifacts/ | grep -v "use client" | grep -v "scripts/" | grep -v "instrumentation" | grep -v "audio-manager" | grep -v "utils.ts" | wc -l
```
This should return a small number (ideally 0 for pure server files).
  </action>
  <verify>
1. Run `grep -rn "console\." --include="*.ts" app/ lib/ artifacts/ | grep -v node_modules | grep -v ".d.ts" | wc -l` to get total remaining console.* count.
2. Run `grep -rn "logger\.\|reqLog\.\|apiLog\.\|childLogger\." --include="*.ts" app/ lib/ artifacts/ | wc -l` to get total structured logging count.
3. Calculate: structured / (structured + console) >= 0.80.
4. Verify no `console.*` in the files listed in this task.
  </verify>
  <done>All server-side route handlers migrated to structured logging. At least 80% of all logging calls use structured logger.* (OBS-02). Error paths use { err: error } pattern for proper stack trace serialization (OBS-04).</done>
</task>

</tasks>

<verification>
1. `grep -rn "console\." --include="*.ts" app/ lib/ artifacts/ | grep -v node_modules | grep -v ".d.ts" | grep -v "scripts/" | grep -v "instrumentation" | wc -l` -- should be under 35 (only client-side files)
2. `grep -rn "logger\." --include="*.ts" app/ lib/ artifacts/ | grep -v node_modules | grep -v ".d.ts" | wc -l` -- should be 150+
3. Percentage structured >= 80% (OBS-02)
4. No `console.*` in any API route handler or lib/ server module (excluding documented exceptions)
5. Error objects logged as `{ err: error }` for pino serialization (OBS-04)
</verification>

<success_criteria>
- 80%+ of all logging calls use structured logger.* (OBS-02)
- Stack traces properly serialized via { err: error } pattern in all error paths (OBS-04)
- Client-side components unmodified
- All server route handlers and lib modules use pino structured logging
</success_criteria>

<output>
After completion, create `.planning/phases/20-observability-cost-controls/20-02-SUMMARY.md`
</output>
