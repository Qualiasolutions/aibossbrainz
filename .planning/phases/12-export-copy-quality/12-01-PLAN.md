---
phase: 12-export-copy-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/pdf/pdf-styles.ts
  - lib/pdf/markdown-parser.ts
  - lib/pdf/pdf-renderer.ts
  - lib/pdf-export.ts
  - lib/conversation-export.ts
  - components/message-actions.tsx
  - components/message-fullscreen.tsx
autonomous: true

must_haves:
  truths:
    - "Single-message PDF export contains formatted text, not a rasterized screenshot image"
    - "Single-message PDF export contains no HTML tags in output"
    - "User can export an entire chat thread as one PDF document from chat header menu"
    - "Exported PDFs are dramatically smaller than current output (text-based, not image-based)"
    - "PDF headings, bold, italic, lists, tables, code blocks, and blockquotes render correctly"
  artifacts:
    - path: "lib/pdf/pdf-styles.ts"
      provides: "Shared PDF style constants (margins, fonts, colors, spacing)"
      exports: ["STYLES"]
    - path: "lib/pdf/markdown-parser.ts"
      provides: "Markdown string to structured block array parser"
      exports: ["parseMarkdown", "PDFBlock", "InlineSegment"]
    - path: "lib/pdf/pdf-renderer.ts"
      provides: "Core rendering engine: blocks to jsPDF native text calls"
      exports: ["renderBlocksToPDF"]
    - path: "lib/pdf-export.ts"
      provides: "Single-message PDF export using native text API"
      exports: ["exportToPDF"]
    - path: "lib/conversation-export.ts"
      provides: "Thread PDF export using native text API"
      exports: ["exportConversationToPDF"]
  key_links:
    - from: "lib/pdf/markdown-parser.ts"
      to: "lib/pdf/pdf-renderer.ts"
      via: "parseMarkdown output feeds renderBlocksToPDF input"
      pattern: "parseMarkdown.*PDFBlock"
    - from: "lib/pdf-export.ts"
      to: "lib/pdf/markdown-parser.ts"
      via: "import parseMarkdown"
      pattern: "import.*parseMarkdown.*from.*pdf/markdown-parser"
    - from: "lib/pdf-export.ts"
      to: "lib/pdf/pdf-renderer.ts"
      via: "import renderBlocksToPDF"
      pattern: "import.*renderBlocksToPDF.*from.*pdf/pdf-renderer"
    - from: "lib/conversation-export.ts"
      to: "lib/pdf/markdown-parser.ts"
      via: "import parseMarkdown"
      pattern: "import.*parseMarkdown.*from.*pdf/markdown-parser"
    - from: "components/message-actions.tsx"
      to: "lib/pdf-export.ts"
      via: "dynamic import for single-message export"
      pattern: "import.*pdf-export"
    - from: "components/message-fullscreen.tsx"
      to: "lib/pdf-export.ts"
      via: "dynamic import for fullscreen message export"
      pattern: "import.*pdf-export"
---

<objective>
Replace html2canvas screenshot-based PDF generation with jsPDF native text rendering for both single-message and thread exports.

Purpose: Current PDFs are rasterized images (10-50x too large, not searchable, contain HTML artifacts). Native text PDFs are small, searchable, and professional. This addresses EXPORT-01, EXPORT-02, and EXPORT-03.

Output: New lib/pdf/ rendering engine, rewritten lib/pdf-export.ts and lib/conversation-export.ts, updated callers in message-actions.tsx and message-fullscreen.tsx.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-export-copy-quality/12-RESEARCH.md

@lib/pdf-export.ts
@lib/conversation-export.ts
@components/message-actions.tsx
@components/message-fullscreen.tsx
@components/chat.tsx
@lib/bot-personalities.ts
@lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PDF rendering engine (lib/pdf/) and install jspdf-autotable</name>
  <files>lib/pdf/pdf-styles.ts, lib/pdf/markdown-parser.ts, lib/pdf/pdf-renderer.ts</files>
  <action>
1. Install jspdf-autotable: `pnpm add jspdf-autotable`

2. Create `lib/pdf/pdf-styles.ts` with shared constants:
   - A4 dimensions (210x297mm), margins (15mm left/right, 20mm top/bottom)
   - Font sizes: h1=18, h2=15, h3=13, body=11, code=10, footer=9
   - lineHeight multiplier: 1.4
   - Spacing: blockSpacing=6mm, listIndent=8mm, codeBlockPadding=4mm, quoteIndent=10mm
   - Colors as RGB tuples: textColor=[26,26,26], headingColor=[26,26,26], mutedColor=[100,100,100], codeBackground=[245,245,245], quoteBarColor=[209,213,219], linkColor=[37,99,235], dividerColor=[229,229,229]
   - Computed contentWidth = pageWidth - marginLeft - marginRight

3. Create `lib/pdf/markdown-parser.ts`:
   - Define `PDFBlock` discriminated union: heading (level 1-3, text), paragraph (segments: InlineSegment[]), list (ordered boolean, items string[]), table (headers string[], rows string[][]), codeblock (language, code), blockquote (text), hr
   - Define `InlineSegment` union: text, bold, italic, bolditalic, code, link (text+url), strikethrough
   - Export `parseMarkdown(text: string): PDFBlock[]` that:
     a. Splits input into lines
     b. Identifies block types line-by-line: code fences (```), headings (#), table rows (|), list items (- or * or 1.), blockquotes (>), horizontal rules (---/***), paragraphs (everything else)
     c. For paragraph blocks, parses inline formatting into InlineSegment[] using regex: ***bold+italic***, **bold**, *italic*, ~~strikethrough~~, `code`, [text](url), plain text
     d. For tables: detect header row + separator row + data rows, parse into headers[] and rows[][]
     e. For lists: collect consecutive list items, detect ordered (1.) vs unordered (- or *)
     f. Handle edge cases: empty lines between blocks produce no output, consecutive paragraphs merge correctly
   - Only handle the markdown subset AI actually produces (headers, bold, italic, lists, tables, code blocks, blockquotes). Do NOT attempt full CommonMark compliance.

4. Create `lib/pdf/pdf-renderer.ts`:
   - Import jsPDF, autoTable from jspdf-autotable, STYLES from pdf-styles, types from markdown-parser
   - Export `renderBlocksToPDF(doc: jsPDF, blocks: PDFBlock[], startY: number): number` that:
     a. Iterates blocks, for each: estimate height, check page break (if y + estimatedHeight > pageHeight - marginBottom, addPage and reset y to marginTop)
     b. heading: setFont helvetica bold, setFontSize per level, splitTextToSize, text(), add keep-with-next padding (30mm minimum remaining) so headings don't orphan at page bottom
     c. paragraph: render each InlineSegment with appropriate font (bold, italic, bolditalic, code=courier, etc.), handle wrapping with splitTextToSize. CRITICAL: set font BEFORE calling splitTextToSize (research pitfall #2)
     d. list: bullet prefix (unordered: "  *  ", ordered: "  N.  ") + indented text using listIndent
     e. table: use autoTable({ head: [headers], body: rows, startY: y, margin: { left: marginLeft }, styles: { fontSize: 10, font: 'helvetica', overflow: 'linebreak' } }), read finalY from (doc as any).lastAutoTable.finalY
     f. codeblock: draw gray background rect, setFont courier normal, render code lines with codeSize
     g. blockquote: draw left bar (quoteBarColor), indent text by quoteIndent, use italic font
     h. hr: draw line from marginLeft to pageWidth-marginRight
   - Use consistent lineHeight = fontSize * STYLES.lineHeight for ALL y-position calculations (research pitfall #1)
   - Return final y position so callers know where content ended
  </action>
  <verify>
  Run `pnpm lint` to check for type errors and formatting issues. Verify jspdf-autotable is in package.json dependencies. Verify all three files export the expected symbols: STYLES, parseMarkdown, PDFBlock, InlineSegment, renderBlocksToPDF.
  </verify>
  <done>
  Three files exist in lib/pdf/ with correct exports. jspdf-autotable installed. Markdown parser handles headings, paragraphs with inline formatting, lists, tables, code blocks, blockquotes, and horizontal rules. Renderer produces jsPDF native text with proper page break handling and consistent Y-position tracking.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite PDF exports and update callers to use native text API</name>
  <files>lib/pdf-export.ts, lib/conversation-export.ts, components/message-actions.tsx, components/message-fullscreen.tsx</files>
  <action>
1. Rewrite `lib/pdf-export.ts`:
   - Remove html2canvas import entirely
   - Change signature to `exportToPDF(text: string, filename: string, executiveName: string, executiveRole: string): Promise<void>`
   - Dynamic import jsPDF, import parseMarkdown and renderBlocksToPDF from lib/pdf/
   - Import STYLES from lib/pdf/pdf-styles
   - Create jsPDF doc ('p', 'mm', 'a4')
   - Render header: executive name (bold, 18pt) + role (normal, 11pt, muted color) + divider line
   - Parse text with parseMarkdown(), render with renderBlocksToPDF()
   - Add footer: italic 9pt muted "Generated by AI Bossy Brainz on {date}"
   - Save with doc.save(`${filename}.pdf`)
   - Follow research code example closely

2. Rewrite `lib/conversation-export.ts` exportConversationToPDF:
   - Remove html2canvas import and all DOM manipulation (no more hidden div, no DOMPurify for PDF path)
   - Keep the `markdownToHtml` function and `escapeHtml` and other utilities (they're imported by message-actions.tsx -- but we'll update that import in step 3)
   - Actually, check: after step 3, markdownToHtml is no longer needed by message-actions.tsx. But keep it anyway in case it's used elsewhere. Do NOT delete any exported functions to avoid breaking imports elsewhere.
   - Dynamic import jsPDF and jspdf-autotable (side-effect import)
   - Import parseMarkdown, renderBlocksToPDF from lib/pdf/, STYLES from lib/pdf/pdf-styles
   - Thread export logic: title header (bold 20pt) + "Conversation with {name} | {date}" subtitle + loop through messages rendering speaker name (bold, colored: user=#333333, bot=#b91c1c) + parseMarkdown(text) + renderBlocksToPDF for each message body + extra spacing between messages
   - Page break check before each message speaker header (need at least 30mm remaining)
   - Footer on last page at pageHeight - 15mm
   - Filename: `{FirstName}-conversation-{YYYY-MM-DD}.pdf`
   - Keep exportConversationToExcel completely unchanged
   - Keep markdownToHtml, escapeHtml, and all helper functions unchanged (they may still be used)

3. Update `components/message-actions.tsx` handleExportPdf:
   - Remove the tempDiv/DOM creation approach entirely
   - Remove the DOMPurify import (check if used elsewhere in this file first -- if not, remove)
   - Remove the imports of `escapeHtml` and `markdownToHtml` from conversation-export (if no longer needed after removing DOM approach)
   - The new exportToPDF takes (text, filename, executiveName, executiveRole) not (element, filename)
   - Pass textFromParts directly as the text argument
   - Pass personality.name and personality.role as executiveName and executiveRole
   - Keep the same filename pattern: `${name}-message-${date}`
   - Keep the same loading state and error handling

4. Update `components/message-fullscreen.tsx` handleExportPDF:
   - Remove contentRef usage for PDF export (no longer screenshotting DOM)
   - The new exportToPDF takes (text, filename, executiveName, executiveRole)
   - Pass `content` prop as the text, personality.name and personality.role for header
   - Keep the same filename pattern and loading state
   - The contentRef and its div can stay for the dialog content display -- just don't use it for PDF export
  </action>
  <verify>
  Run `pnpm lint` to verify no type errors. Run `pnpm build` to check for compile errors (may fail due to missing env vars, but TypeScript compilation errors will show). Verify: (1) No html2canvas import remains in pdf-export.ts or conversation-export.ts, (2) message-actions.tsx no longer creates tempDiv/DOM for PDF, (3) message-fullscreen.tsx calls exportToPDF with text string not DOM element.
  </verify>
  <done>
  Single-message PDF export (message-actions.tsx and message-fullscreen.tsx) calls rewritten exportToPDF with text input producing native text PDFs. Thread export (chat.tsx -> conversation-export.ts) uses native text rendering. No html2canvas in any PDF export path. html2canvas remains only for strategy canvas SWOT board.
  </done>
</task>

</tasks>

<verification>
1. Grep for html2canvas in pdf-export.ts and conversation-export.ts -- must return no results
2. Grep for html2canvas in swot-board.tsx -- must still exist (untouched)
3. `pnpm lint` passes
4. All exports match: exportToPDF in pdf-export.ts, exportConversationToPDF in conversation-export.ts
5. Import chain: message-actions.tsx -> pdf-export.ts -> lib/pdf/markdown-parser + lib/pdf/pdf-renderer
6. Import chain: chat.tsx -> conversation-export.ts -> lib/pdf/markdown-parser + lib/pdf/pdf-renderer
</verification>

<success_criteria>
- EXPORT-01: PDF exports produce clean formatted text (no HTML tags)
- EXPORT-02: Thread export works via chat header menu (exportConversationToPDF rewritten)
- EXPORT-03: PDFs are text-based (~10-50KB) instead of image-based (~2-12MB)
- All export buttons (message actions, fullscreen modal, chat header) work with the new rendering engine
- html2canvas removed from all PDF text export paths, preserved only for strategy canvas
</success_criteria>

<output>
After completion, create `.planning/phases/12-export-copy-quality/12-01-SUMMARY.md`
</output>
