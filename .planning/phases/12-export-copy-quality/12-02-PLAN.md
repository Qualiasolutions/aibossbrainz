---
phase: 12-export-copy-quality
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - lib/clipboard-utils.ts
  - components/message-actions.tsx
  - components/message-fullscreen.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking Copy on a message puts clean text (no markdown syntax) into the clipboard"
    - "Copy in fullscreen modal also produces clean text without markdown formatting"
    - "Copied text has no asterisks, hash marks, backticks, or bracket-URL patterns"
    - "Code content within code fences is preserved (only fence markers removed)"
    - "Links are converted to readable format: text (url)"
  artifacts:
    - path: "lib/clipboard-utils.ts"
      provides: "stripMarkdownForClipboard utility function"
      exports: ["stripMarkdownForClipboard"]
    - path: "components/message-actions.tsx"
      provides: "Updated handleCopy using stripMarkdownForClipboard"
    - path: "components/message-fullscreen.tsx"
      provides: "Updated handleCopy using stripMarkdownForClipboard"
  key_links:
    - from: "components/message-actions.tsx"
      to: "lib/clipboard-utils.ts"
      via: "import stripMarkdownForClipboard"
      pattern: "import.*stripMarkdownForClipboard.*from.*clipboard-utils"
    - from: "components/message-fullscreen.tsx"
      to: "lib/clipboard-utils.ts"
      via: "import stripMarkdownForClipboard"
      pattern: "import.*stripMarkdownForClipboard.*from.*clipboard-utils"
---

<objective>
Add markdown stripping for clipboard copy so users get clean, readable text when copying messages.

Purpose: Currently, copying a message puts raw markdown (with **bold**, # headers, `code`, [links](url)) into the clipboard. Users paste this into emails and documents and get formatting artifacts. This addresses EXPORT-04.

Output: New lib/clipboard-utils.ts with stripMarkdownForClipboard, updated copy handlers in message-actions.tsx and message-fullscreen.tsx.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-export-copy-quality/12-RESEARCH.md
@.planning/phases/12-export-copy-quality/12-01-SUMMARY.md

@components/message-actions.tsx
@components/message-fullscreen.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create clipboard-utils.ts and update all copy handlers</name>
  <files>lib/clipboard-utils.ts, components/message-actions.tsx, components/message-fullscreen.tsx</files>
  <action>
1. Create `lib/clipboard-utils.ts`:
   - Export `stripMarkdownForClipboard(text: string): string` that:
     a. Remove code fences but keep content: ```lang\n...\n``` -> content only
     b. Remove inline code backticks: `code` -> code
     c. Remove bold+italic markers: ***text*** -> text
     d. Remove bold markers: **text** -> text
     e. Remove italic markers: *text* -> text (but not mid-word underscores)
     f. Remove underscore bold: __text__ -> text
     g. Remove underscore italic: _text_ -> text (word-boundary aware)
     h. Remove strikethrough: ~~text~~ -> text
     i. Convert links: [text](url) -> text (url)
     j. Remove heading markers: ### heading -> heading
     k. Remove blockquote markers: > text -> text
     l. Keep horizontal rules as --- (simple separator)
     m. Clean up excessive whitespace: 3+ newlines -> 2 newlines
     n. Trim result
   - Order matters: process bold+italic (***) BEFORE bold (**) BEFORE italic (*)
   - Follow the regex patterns from 12-RESEARCH.md code example closely

2. Update `components/message-actions.tsx` handleCopy:
   - Import stripMarkdownForClipboard from @/lib/clipboard-utils
   - In handleCopy, wrap textFromParts: `const cleanText = stripMarkdownForClipboard(textFromParts)`
   - Pass cleanText to copyToClipboard instead of textFromParts
   - This applies to BOTH user message copy and assistant message copy (the function is used for both)

3. Update `components/message-fullscreen.tsx` handleCopy:
   - Import stripMarkdownForClipboard from @/lib/clipboard-utils
   - In handleCopy, wrap content: `const cleanText = stripMarkdownForClipboard(content)`
   - Pass cleanText to copyToClipboard instead of content

4. Run `pnpm lint` and `pnpm format` to ensure consistent formatting.
  </action>
  <verify>
  Run `pnpm lint` -- must pass with no errors. Verify stripMarkdownForClipboard is imported in both message-actions.tsx and message-fullscreen.tsx. Grep for `copyToClipboard(textFromParts)` and `copyToClipboard(content)` -- these raw calls should no longer exist (replaced with cleanText versions).
  </verify>
  <done>
  Copy button in message actions and fullscreen modal produces clean text without markdown formatting. stripMarkdownForClipboard handles all common markdown patterns: bold, italic, headers, code fences, inline code, links, blockquotes, strikethrough. Users can paste into emails/documents without formatting artifacts.
  </done>
</task>

</tasks>

<verification>
1. Grep for `copyToClipboard(textFromParts)` in message-actions.tsx -- must NOT exist
2. Grep for `copyToClipboard(content)` in message-fullscreen.tsx -- must NOT exist
3. Grep for `stripMarkdownForClipboard` in message-actions.tsx and message-fullscreen.tsx -- must exist in both
4. `pnpm lint` passes
</verification>

<success_criteria>
- EXPORT-04: Copy/paste from chat produces clean text without markdown syntax
- Both copy locations (message actions bar, fullscreen modal) use the stripping utility
- Code content is preserved (only fence/backtick markers removed)
- Links converted to readable "text (url)" format
</success_criteria>

<output>
After completion, create `.planning/phases/12-export-copy-quality/12-02-SUMMARY.md`
</output>
