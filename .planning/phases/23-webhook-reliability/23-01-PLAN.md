---
phase: 23-webhook-reliability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/stripe/webhook/route.ts
  - lib/stripe/webhook-dedup.ts
  - supabase/migrations/20260218000200_webhook_reliability.sql
autonomous: true
user_setup:
  - service: supabase
    why: "New migration must be applied via Supabase Dashboard SQL Editor"
    dashboard_config:
      - task: "Run migration 20260218000200_webhook_reliability.sql in SQL Editor"
        location: "Supabase Dashboard -> SQL Editor -> paste migration content"

must_haves:
  truths:
    - "Stripe webhook route has maxDuration = 60 to prevent Vercel timeout"
    - "Duplicate Stripe events with the same event ID are detected and skipped"
    - "customer.subscription.updated handler uses event-ID dedup instead of no idempotency check"
    - "invoice.paid handler uses event-ID dedup instead of no idempotency check"
    - "Old status-based isAlreadyProcessed is replaced by event-ID-based dedup for all handlers"
  artifacts:
    - path: "app/api/stripe/webhook/route.ts"
      provides: "maxDuration export + event-ID dedup on all handlers"
      contains: "maxDuration"
    - path: "lib/stripe/webhook-dedup.ts"
      provides: "Event deduplication logic via StripeWebhookEvent table"
      exports: ["markEventProcessed"]
    - path: "supabase/migrations/20260218000200_webhook_reliability.sql"
      provides: "StripeWebhookEvent table with unique constraint on eventId"
      contains: "StripeWebhookEvent"
  key_links:
    - from: "app/api/stripe/webhook/route.ts"
      to: "lib/stripe/webhook-dedup.ts"
      via: "import markEventProcessed"
      pattern: "markEventProcessed"
    - from: "lib/stripe/webhook-dedup.ts"
      to: "StripeWebhookEvent table"
      via: "supabase.from('StripeWebhookEvent').insert()"
      pattern: "StripeWebhookEvent"
---

<objective>
Add maxDuration export and event-ID-based idempotency to the Stripe webhook handler, replacing the status-based isAlreadyProcessed approach.

Purpose: Fix medium-severity audit findings M-8 through M-11 -- the webhook currently has no timeout protection and uses status-based idempotency that fails on intermediate state changes.
Output: Webhook route with maxDuration, StripeWebhookEvent dedup table, all event handlers using event-ID-based deduplication.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-webhook-reliability/23-RESEARCH.md
@app/api/stripe/webhook/route.ts
@lib/stripe/actions.ts
@lib/stripe/config.ts
@lib/supabase/types.ts
@supabase/migrations/20260218000100_add_ai_cost_log.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StripeWebhookEvent table migration and dedup module</name>
  <files>
    supabase/migrations/20260218000200_webhook_reliability.sql
    lib/stripe/webhook-dedup.ts
    lib/supabase/types.ts
  </files>
  <action>
    1. Create migration `supabase/migrations/20260218000200_webhook_reliability.sql`:
       - Create `StripeWebhookEvent` table:
         - `id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text`
         - `"eventId" TEXT NOT NULL UNIQUE` (unique constraint for dedup)
         - `"eventType" TEXT NOT NULL`
         - `"userId" TEXT` (nullable -- some events may not have a userId)
         - `"processedAt" TIMESTAMPTZ NOT NULL DEFAULT NOW()`
       - Add index on `"processedAt"` for cleanup queries: `CREATE INDEX idx_stripe_webhook_event_processed ON "StripeWebhookEvent"("processedAt")`
       - Enable RLS: `ALTER TABLE "StripeWebhookEvent" ENABLE ROW LEVEL SECURITY`
       - Add service-role-only policy: `CREATE POLICY "Service role full access" ON "StripeWebhookEvent" FOR ALL USING (auth.role() = 'service_role')`
       - Follow the exact naming pattern from `20260218000100_add_ai_cost_log.sql` (camelCase columns, gen_random_uuid()::text, TIMESTAMPTZ DEFAULT NOW())

    2. Create `lib/stripe/webhook-dedup.ts`:
       - Import `createServiceClient` from `@/lib/supabase/server`
       - Import `logger` from `@/lib/logger`
       - Export `async function markEventProcessed(eventId: string, eventType: string, userId: string | null): Promise<boolean>`
         - Uses `createServiceClient()` to insert into `StripeWebhookEvent`
         - Insert `{ eventId, eventType, userId, processedAt: new Date().toISOString() }`
         - If insert succeeds, return `true` (event is new, proceed with processing)
         - If error code is `"23505"` (unique constraint violation), log info and return `false` (duplicate, skip)
         - If any other error, log error and throw (unexpected failure)
       - Add `"server-only"` import at the top

    3. Add type alias to `lib/supabase/types.ts`:
       - Add `export type StripeWebhookEvent = Database["public"]["Tables"]["StripeWebhookEvent"]["Row"];` after the existing type aliases
       - NOTE: The actual database.types.ts will need regeneration via `pnpm gen:types` after migration is applied. For now, the type alias is a placeholder that will work once types are regenerated. If database.types.ts doesn't yet have the table, skip the type alias and add a TODO comment.
  </action>
  <verify>
    - `pnpm build` compiles without errors (the webhook-dedup module should compile even before migration is applied since it only uses string-based table names)
    - `grep -c "23505" lib/stripe/webhook-dedup.ts` returns 1 (unique constraint handling)
    - `grep -c "StripeWebhookEvent" supabase/migrations/20260218000200_webhook_reliability.sql` returns 3+ (table creation, index, RLS policy)
  </verify>
  <done>
    StripeWebhookEvent migration exists with unique constraint on eventId. webhook-dedup.ts exports markEventProcessed that returns true for new events and false for duplicates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add maxDuration and replace isAlreadyProcessed with event-ID dedup</name>
  <files>
    app/api/stripe/webhook/route.ts
  </files>
  <action>
    1. Add `export const maxDuration = 60;` at the top of the file (after imports, before webhookSecret). Value is 60 (not 30) because Stripe SDK has 30s timeout + 2 retries = 90s worst case, and 60s gives headroom. Per research, explicit is better than relying on Vercel defaults.

    2. Import `markEventProcessed` from `@/lib/stripe/webhook-dedup`

    3. Remove the entire `isAlreadyProcessed` function (lines ~70-86). It is being replaced by event-ID-based dedup.

    4. Add a dedup helper that extracts userId from different event types and calls markEventProcessed. Right after signature verification succeeds and before the switch statement, add:
       ```typescript
       // Event-ID dedup: check if this exact event was already processed
       const isNew = await markEventProcessed(
         event.id,
         event.type,
         extractUserId(event),
       );
       if (!isNew) {
         reqLog.info({ eventId: event.id, eventType: event.type }, "Duplicate event, skipping");
         return NextResponse.json({ received: true });
       }
       ```

    5. Create a local `extractUserId` function that inspects the event type and extracts the userId from metadata:
       - For `checkout.session.completed`: `(event.data.object as Stripe.Checkout.Session).metadata?.userId`
       - For `customer.subscription.created`, `customer.subscription.updated`, `customer.subscription.deleted`: `(event.data.object as Stripe.Subscription).metadata?.userId`
       - For `invoice.paid`, `invoice.payment_failed`: null (userId is not in invoice metadata directly; it's retrieved from subscription metadata after API call)
       - Default: null

    6. Remove all the per-handler `isAlreadyProcessed` calls in:
       - `checkout.session.completed` handler (remove the if-block that calls isAlreadyProcessed around line 149-161)
       - `customer.subscription.created` handler (remove the if-block that calls isAlreadyProcessed around line 248-260)
       These are no longer needed since dedup happens once at the top level for ALL events.

    7. The `customer.subscription.updated` and `invoice.paid` handlers previously had NO idempotency check at all (audit findings M-10, M-11). They are now automatically covered by the top-level dedup.

    8. Preserve all existing `after()` blocks for Mailchimp tagging and emails -- they should remain unchanged.
  </action>
  <verify>
    - `pnpm build` succeeds
    - `pnpm lint` passes
    - `grep -c "isAlreadyProcessed" app/api/stripe/webhook/route.ts` returns 0 (old function removed)
    - `grep -c "markEventProcessed" app/api/stripe/webhook/route.ts` returns 1+ (new dedup used)
    - `grep -c "maxDuration" app/api/stripe/webhook/route.ts` returns 1
    - `grep -c "extractUserId" app/api/stripe/webhook/route.ts` returns 2+ (definition + usage)
  </verify>
  <done>
    Webhook route exports maxDuration = 60. All event types are deduped via event-ID at the top level before the switch statement. The old status-based isAlreadyProcessed function is removed. subscription.updated and invoice.paid now have idempotency protection they previously lacked.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds with no type errors
- `pnpm lint` passes
- The webhook route exports `maxDuration = 60`
- `markEventProcessed` is called once before the switch statement for all events
- No trace of `isAlreadyProcessed` remains in the webhook route
- Migration SQL creates `StripeWebhookEvent` with `UNIQUE` constraint on `"eventId"`
</verification>

<success_criteria>
1. maxDuration = 60 is exported from the webhook route
2. StripeWebhookEvent table migration exists with unique eventId constraint
3. webhook-dedup.ts handles duplicate detection via INSERT + unique constraint violation
4. All 5 subscription-mutating event types (checkout.session.completed, subscription.created, subscription.updated, invoice.paid, subscription.deleted) are covered by event-ID dedup
5. Old isAlreadyProcessed function is completely removed
</success_criteria>

<output>
After completion, create `.planning/phases/23-webhook-reliability/23-01-SUMMARY.md`
</output>
