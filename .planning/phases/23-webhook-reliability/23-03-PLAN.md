---
phase: 23-webhook-reliability
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/stripe/webhook/route.ts
  - supabase/migrations/20260218000300_webhook_reliability_gaps.sql
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "429 response from webhook rate limit includes Retry-After header with seconds until window reset"
    - "process_webhook_event RPC has SET search_path = public alongside SECURITY DEFINER"
    - "WebhookDeadLetter table has a nullable resolvedAt TIMESTAMPTZ column"
    - "An index exists on resolvedAt for filtering unresolved dead-letter entries"
  artifacts:
    - path: "app/api/stripe/webhook/route.ts"
      provides: "Retry-After header on 429 response"
      contains: "Retry-After"
    - path: "supabase/migrations/20260218000300_webhook_reliability_gaps.sql"
      provides: "ALTER TABLE + CREATE OR REPLACE FUNCTION fixes"
      contains: "SET search_path = public"
  key_links:
    - from: "app/api/stripe/webhook/route.ts"
      to: "Stripe retry behavior"
      via: "Retry-After header in 429 response"
      pattern: "Retry-After.*60"
---

<objective>
Close three verification gaps from phase 23: add Retry-After header to webhook 429 response, add SET search_path = public to process_webhook_event RPC, and add resolvedAt column to WebhookDeadLetter table.

Purpose: All three gaps are security/operational hardening issues flagged during verification. Closing them brings phase 23 to 9/9 must-haves verified.
Output: Patched webhook route + new migration for DB-level fixes.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-webhook-reliability/23-02-SUMMARY.md
@.planning/phases/23-webhook-reliability/23-VERIFICATION.md

# Key source files
@app/api/stripe/webhook/route.ts
@supabase/migrations/20260218000200_webhook_reliability.sql
@lib/security/rate-limiter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Retry-After header to webhook 429 response</name>
  <files>app/api/stripe/webhook/route.ts</files>
  <action>
In `app/api/stripe/webhook/route.ts`, find the 429 rate-limit response block (lines ~113-119):

```typescript
if (!rateLimitResult.allowed) {
    logger.warn({ clientIp }, "Webhook rate limit exceeded");
    return NextResponse.json(
        { error: "Rate limit exceeded" },
        { status: 429 },
    );
}
```

Replace the response with one that includes the `Retry-After` header. The webhook rate limit window is 60 seconds (WEBHOOK_RATE_LIMIT_WINDOW constant in rate-limiter.ts). Use `Retry-After: 60` as the header value — this tells Stripe to wait 60 seconds before retrying.

Updated code:

```typescript
if (!rateLimitResult.allowed) {
    logger.warn({ clientIp }, "Webhook rate limit exceeded");
    return NextResponse.json(
        { error: "Rate limit exceeded" },
        {
            status: 429,
            headers: { "Retry-After": "60" },
        },
    );
}
```

Do NOT import WEBHOOK_RATE_LIMIT_WINDOW — it is not exported and should stay private to rate-limiter.ts. Hardcoding "60" is correct here since the webhook rate limit window is a stable architectural constant.
  </action>
  <verify>
1. `grep -n "Retry-After" app/api/stripe/webhook/route.ts` shows the header in the 429 response block.
2. `pnpm build` compiles without errors.
  </verify>
  <done>The webhook 429 response includes a Retry-After: 60 header so Stripe knows when to retry.</done>
</task>

<task type="auto">
  <name>Task 2: Fix RPC search_path + add resolvedAt column via new migration</name>
  <files>supabase/migrations/20260218000300_webhook_reliability_gaps.sql</files>
  <action>
Create a NEW migration file `supabase/migrations/20260218000300_webhook_reliability_gaps.sql` that addresses two DB-level gaps. Do NOT modify the existing 20260218000200 migration — it may already be applied in production.

The migration must contain:

**1. Add resolvedAt column to WebhookDeadLetter:**

```sql
-- Gap 3: Add resolvedAt column for tracking manual resolution/replay
ALTER TABLE "WebhookDeadLetter"
ADD COLUMN IF NOT EXISTS "resolvedAt" TIMESTAMPTZ;

CREATE INDEX IF NOT EXISTS idx_webhook_dead_letter_resolved
ON "WebhookDeadLetter"("resolvedAt")
WHERE "resolvedAt" IS NULL;
```

Use a partial index (`WHERE "resolvedAt" IS NULL`) since the primary query pattern is filtering unresolved entries. This is more efficient than a full index.

**2. Recreate process_webhook_event RPC with SET search_path = public:**

```sql
-- Gap 2: Add SET search_path = public to SECURITY DEFINER function
CREATE OR REPLACE FUNCTION process_webhook_event(
    event_id TEXT,
    event_type TEXT,
    user_id TEXT DEFAULT NULL
) RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
    lock_key BIGINT;
    existing_event_id TEXT;
BEGIN
    lock_key := COALESCE(hashtext(user_id), 0);
    PERFORM pg_advisory_xact_lock(lock_key);

    SELECT "eventId" INTO existing_event_id
    FROM "StripeWebhookEvent"
    WHERE "eventId" = event_id;

    IF existing_event_id IS NOT NULL THEN
        RETURN FALSE;
    END IF;

    INSERT INTO "StripeWebhookEvent" ("eventId", "eventType", "userId")
    VALUES (event_id, event_type, user_id);

    RETURN TRUE;
END;
$$;
```

The function body is identical to the original — the only change is adding `SET search_path = public` after `SECURITY DEFINER`. `CREATE OR REPLACE` safely updates the existing function.
  </action>
  <verify>
1. File exists at `supabase/migrations/20260218000300_webhook_reliability_gaps.sql`.
2. `grep "SET search_path = public" supabase/migrations/20260218000300_webhook_reliability_gaps.sql` matches.
3. `grep "resolvedAt" supabase/migrations/20260218000300_webhook_reliability_gaps.sql` matches.
4. `grep "WHERE.*resolvedAt.*IS NULL" supabase/migrations/20260218000300_webhook_reliability_gaps.sql` confirms partial index.
  </verify>
  <done>New migration adds resolvedAt column with partial index to WebhookDeadLetter and recreates process_webhook_event with SET search_path = public. Migration is additive and safe to apply on top of existing 20260218000200.</done>
</task>

</tasks>

<verification>
1. `pnpm build` passes — no TypeScript errors from the Retry-After header change.
2. `grep -c "Retry-After" app/api/stripe/webhook/route.ts` returns 1.
3. `supabase/migrations/20260218000300_webhook_reliability_gaps.sql` exists with both fixes.
4. The migration SQL is valid: ALTER TABLE for resolvedAt + CREATE OR REPLACE FUNCTION with SET search_path = public.
5. All three verification gaps from 23-VERIFICATION.md are addressed.
</verification>

<success_criteria>
- Webhook 429 response includes Retry-After: 60 header (Gap 1 closed)
- process_webhook_event RPC includes SET search_path = public (Gap 2 closed)
- WebhookDeadLetter has resolvedAt TIMESTAMPTZ nullable column (Gap 3 closed)
- Partial index on resolvedAt WHERE NULL for efficient unresolved entry queries (Gap 3 closed)
- New migration is additive (does not modify existing applied migration)
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/23-webhook-reliability/23-03-SUMMARY.md`
</output>
